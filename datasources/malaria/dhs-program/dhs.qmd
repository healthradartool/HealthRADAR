---
title: "The Demographic and Health Surveys Program"
description: "The Demographic and Health Surveys (DHS) Program has collected population survey data from over 90 countries for over 30 years."
date: 07/04/2024 # mm-dd-yyyy
image: "images/dhs.png"
execute:
  message: false
  warning: false

language: 
  title-block-published: "Last updated"
  
page-layout: full
title-block-banner: "#EDF3F9"
title-block-banner-color: "#212529"
categories:
  - malaria
  - epidemiology
  - country-level
  - annual
---

## About the data

The DHS (Demographic and Health Surveys) Program provides data on population, health, and nutrition through more than 400 surveys in over 90 countries. Data covers the following areas; *Population and Demographics, Fertility and Family Planning, Maternal and Child Health, Nutrition, HIV/AIDS and Other Infections, Malaria, & Gender and Domestic Violence*.

The DHS data are widely used by governments, NGOs, researchers, and policymakers to design and monitor health programs and policies. The surveys are conducted through face-to-face interviews with representative samples of households, and they use standardized questionnaires to ensure comparability across countries and over time.

Demographic health surveys are also unique for modelling as you can correlate across various datasets variables for example linking Malaria data on prevention and treatment to other factors in the population and demographics data to other health system indicators

## Accessing the data

There are several options for accessing the data, each thoroughly explained in other resources.

::: {.panel-tabset}

## DHS Website

[The DHS Program Access Instructions:](https://www.dhsprogram.com/data/Access-Instructions.cfm) This requires signing up for a free user account.

{{< video https://www.youtube.com/embed/videoseries?amp;list=PLagqLv-gqpTNBR0KcyrajAqKrFdsdIqqe >}}


## STATcompiler

[STATcompiler](https://www.statcompiler.com/en/), a graphical user interface tool for accessing and downloading the data in CSV format.

{{< video https://youtu.be/eXdPi6a_pQ0?list=PLagqLv-gqpTNRdiY391wMY0lzM_MuYpAL >}}

#### Accessing the data using STATcompiler

-   **Prevalence and Treatment**: Users can access data on malaria prevalence and treatment practices directly from the [STATcompiler](https://www.STATcompiler%20.com/en/). It allows for the creation of tables, charts, and maps that display malaria prevalence rates, treatment practices, and trends over time.

-   **Preventive Measures**: STATcompiler provides data on the ownership and use of ITNs, IRS coverage, and IPTp usage. Users can visualize how these preventive measures vary across different regions and demographic groups.


-   **Country and Regional Comparisons**: STATcompiler enables users to compare malaria data across different countries and regions. This comparative analysis helps in identifying best practices and areas that require more attention.

-   **Temporal Trends**: Users can analyze trends over time to see how malaria prevention and treatment efforts have evolved and their impact on malaria prevalence and morbidity

-   **Tailored Data Retrieval**: STATcompiler allows users to create custom tables based on specific indicators related to malaria. Users can filter data by variables such as age, sex, urban/rural residence, and wealth quintile.

-   **Indicator Selection**: Users can select specific indicators related to malaria, such as ITN usage, malaria prevalence among children under five, and access to malaria treatment. This customization helps in focusing on particular aspects of malaria control and prevention.

-   **Holistic Health Analysis**: STATcompiler can integrate malaria data with other health indicators, such as child mortality rates, nutrition status, and maternal health. This integration provides a comprehensive view of health challenges and the interconnections between different health issues.

-   **Multi-Indicator Analysis**: Users can analyse how malaria prevention and treatment efforts correlate with other health outcomes, facilitating a broader understanding of health dynamics.

-   **Interactive Tools**: STATcompiler offers an interactive and user-friendly interface, making it easy for users to navigate and extract relevant malaria data.

-   **Data Export**: Users can export data in various formats (e.g., Excel, CSV) for further analysis or reporting purposes.

#### Practical Applications using STATcompiler to access DHS program data

-   **Policy Making and Program Design**: Policymakers and program designers can access up-to-date malaria data, helping them create evidence-based strategies and allocate resources effectively.

-   **Research and Academic Studies**: Researchers can utilize STATcompiler to obtain detailed malaria data for their studies, facilitating in-depth analysis and publication of findings.

-   **Monitoring and Evaluation**: Health organizations can monitor the progress of malaria interventions by analysing trends and identifying gaps in coverage .

By leveraging the capabilities of STATcompiler, users can efficiently analyse and visualise malaria data collected by the DHS Program, leading to more informed decisions and effective interventions in malaria control and prevention.

## R package

The Demographic and Health Surveys (DHS) Program has developed an open-source R package [`rdhs`](https://docs.ropensci.org/rdhs/) for management and analysis of Demographic and Health Survey data. This includes functionality to:

1.  Access standard indicator data (i.e. [DHS STATcompiler](https://www.statcompiler.com/)) in R via the [DHS API](https://api.dhsprogram.com/).

2.  Identify surveys and datasets relevant to a particular analysis.

3.  Download survey datasets from the [DHS website](https://dhsprogram.com/data/available-datasets.cfm).

4.  Load datasets and associated metadata into R.

5.  Extract variables and combining datasets for pooled multi-survey analyses.


:::

## What does the data look like?

**Description**

DHS data on malaria covers the following area for malaria

-   Prevalence and Treatment
-   Preventive Measures
-   Awareness and Behaviour
-   Health System and Access to Care
-   Impact of Malaria Interventions

The indicator dataset guide can found at [The DHS Program - Malaria](https://www.dhsprogram.com/topics/malaria/index.cfm)

![Malaria Data in DHS Surveys](images/malaria%20data%20in%20dhs%20survey.png)

::: {.callout-note collapse="true"}
## How to plot this data?

```{r}
#| include: false
#| message: false
#| warning: false

library("knitr")
library(tidyverse)
library(viridis)
library(sf)
library(RColorBrewer)
library(rdhs)

knitr::opts_chunk$set(echo = T, cache = T, warning = F, message = F, fig.pos = 'H', cache = T)
options(digits=4, scipen = 9)
```

```{r}
#| message: false
#| warning: false

indicators <- dhs_indicators()

# Display the first 5 indicators
#indicators[order(indicators$IndicatorId),][1:5,c("IndicatorId", "Definition")]

# Find all indicators starting with ML
all_malaria_indicators = indicators[grepl("^ML", indicators$IndicatorId), c("IndicatorId", "Definition")]
#all_malaria_indicators

# Find the definition for indicator ML_FEVT_C_AML
#indicators[indicators$IndicatorId == "ML_FEVT_C_AML", "Definition"]


# Find the definition for indicator ML_NETP_H_MOS
#indicators[indicators$IndicatorId == "ML_NETP_H_MOS", "Definition"]

tags <- dhs_tags()

# Get the tags related to malaria
#tags[grepl("Malaria", tags$TagName), ]
```

```{r}
#| message: false
#| warning: false

# Get the country codes of the frontline 4 of the elimination 8 countries
all_countries = dhs_countries(returnFields=c("CountryName","DHS_CountryCode"))

# Get the country codes of the frontline 4 of the elimination 8 countries
frontline4 = c("Botswana", "Namibia", "South Africa", "Eswatini")
elim8 = c("Botswana", "Namibia", "South Africa", "Eswatini", "Zambia", "Zimbabwe", "Mozambique", "Malawi")

# Get the country codes of the frontline 4 of the elimination 8 countries
f4_codes = all_countries[all_countries$CountryName %in% frontline4, "DHS_CountryCode"]
e8_codes = all_countries[all_countries$CountryName %in% elim8, "DHS_CountryCode"]

```

```{r}

# Retrieve DHS data for the specified indicator, countries, and survey years
data1 <- dhs_data(indicatorIds = "ML_NETP_H_MOS",
                 countryIds = f4_codes,
                 surveyYearStart = 2000,
                 breakdown = "subnational")

# Remove rows with CharacteristicLabel starting with ".." to avoid double counting regions
filt_data = data1[!grepl("^\\..*", data1$CharacteristicLabel),]

# Filter the data for Namibia only
filt_data = filt_data[filt_data$CountryName == "Namibia",]

# Define a single color for the bars
single_color <- "#1b9e77"

# Plot the data as a bar plot
ggplot(filt_data, aes(x = as.factor(SurveyYear), y = Value, fill = single_color, color = "black")) +
  # Create bar plot with identity statistic and no legend
  geom_bar(stat = "identity", position = "dodge", show.legend = FALSE) + 
  # Use the defined color for fill and set border color to black
  scale_fill_identity() +
  scale_color_identity() +  
  # Set y-axis ticks increment to 10
  scale_y_continuous(breaks = seq(0, max(filt_data$Value, na.rm = TRUE), by = 10)) +  
  # Add titles and labels
  labs(
    title = "Households with at least one mosquito net in Namibia",
    subtitle = "Based on subnational DHS survey data",
    x = "Survey Year",
    y = "Percentage of Households",
    caption = "Source: DHS Data API - Malaria Indicator ML_NETP_H_MOS"
  ) +
  # Facet the plot by CharacteristicLabel, with 6 columns
  facet_wrap(~ CharacteristicLabel, ncol = 6) +
  # Apply a minimal theme with customisations
  theme_minimal() +
  theme(
    # Center and style the plot title and subtitle
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    # Style the axis titles and text
    axis.title = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    # Style the plot caption
    plot.caption = element_text(hjust = 0, size = 10, face = "italic"),
    # Adjust the plot margins
    plot.margin = margin(t = 20, r = 20, b = 40, l = 20),
    # Style the facet strip text
    strip.text = element_text(size = 12, face = "bold"),
    # Remove the legend
    legend.position = "none",  
    # Add light background to each facet panel
    panel.background = element_rect(fill = "#F0F0F0", color = NA),  
    # Add spacing between panels
    panel.spacing = unit(0.5, "lines")  
  )

```

```{r}

# Retrieve DHS data for the specified indicator, countries, and survey years
data2 <- dhs_data(indicatorIds = "ML_NETP_H_MNM",
                 countryIds = e8_codes,
                 surveyYearStart = 2000,
                 breakdown = "subnational")

# Keep only the rows where the level rank is 1 (national level data)
filt_data = data2[data2$LevelRank == 1,]

# Remove rows with CharacteristicLabel starting with ".." to avoid double counting regions
filt_data = filt_data[!grepl("^\\..*", filt_data$CharacteristicLabel),]

# Plot the data using ggplot2
ggplot(filt_data, aes(x = SurveyYear, y = Value, colour = CountryName)) +
  # Add points to the plot
  geom_point(size = 2) +
  # Add a smooth line using a generalised linear model, with confidence interval shading
  geom_smooth(method = "glm", se = TRUE, alpha = 0.3) +
  # Facet the plot by CountryName, with 3 columns and free y-axis scales
  facet_wrap(~ CountryName, ncol = 3, scales = "free_y") +
  # Add titles and labels
  labs(
    title = "Trend of mean number of mosquito nets by E8 country",
    subtitle = "Based on subnational survey data from various years",
    x = "Survey Year",
    y = "Mean Nets Per Household",
    colour = "Country",
    caption = "Source: DHS Data API - Malaria Indicator ML_NETP_H_MNM"
  ) +
  # Apply a minimal theme with customizations
  theme_minimal() +
  theme(
    # Center and style the plot title and subtitle
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    # Style the axis titles and text
    axis.title = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12),
    # Rotate x-axis text for better readability
    axis.text.x = element_text(angle = 90, vjust = 0.5),
    # Style the legend title and text
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    # Style the plot caption
    plot.caption = element_text(hjust = 0, size = 10, face = "italic"),
    # Adjust the plot margins
    plot.margin = margin(t = 20, r = 20, b = 40, l = 20)
  ) +
  # Center the legend title
  guides(colour = guide_legend(title.position = "top", title.hjust = 0.5))

```

Subnational data - mean number of mosquito nets by E8 country Each point represents the mean number of nets in a specific subregion of the country. The line represents the trend over time for each country. The shaded area represents the 95% confidence interval for the trend line. Add brief descriptions for each one.

```{r}

# Filter the data for Zambia for the year 2018
d = data2[(data2$CountryName == "Zambia" & data2$SurveyYear == 2018),]

# Download the related spatial data frame object for Zambia
sp <- download_boundaries(surveyId = d$SurveyId[1], method = "sf")

# Match our values to the regions in the spatial data
m <- d$Value[match(sp$sdr_subnational_boundaries$REG_ID, d$RegionId)]
sp$sdr_subnational_boundaries$Value <- m

# Plot the spatial data using ggplot2
ggplot(sp$sdr_subnational_boundaries) + 
  # Add a filled polygon layer for each region
  geom_sf(aes(fill = Value), color = "lightgrey", size = 0.3) + 
  # Use the viridis color scale for the fill, with specific options and NA value color
  scale_fill_viridis_c(option = "plasma", na.value = "grey50", name = "Value") +
  # Add titles and labels
  labs(
    title = "Mean number of mosquito nets in Zambia",
    subtitle = "Based on subnational DHS survey data from 2018",
    caption = "Source: DHS Data API - Malaria Indicator ML_NETP_H_MNM",
    x = "Longitude",
    y = "Latitude"
  ) +
  # Apply a minimal theme with customizations
  theme_minimal() +
  theme(
    # Center and style the plot title and subtitle
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    # Style the axis titles and text
    axis.title = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12),
    # Style the legend title and text
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    # Style the plot caption
    plot.caption = element_text(hjust = 0, size = 10, face = "italic"),
    # Adjust the plot margins
    plot.margin = margin(t = 20, r = 20, b = 40, l = 20)
  ) +
  # Center the legend title
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5))

```

```{r}
library(leaflet)

# Make a request to DHS data API for Malawi, for the specified indicator, and survey years
d2 <- dhs_data(countryIds = "MW",
              indicatorIds = "ML_FEVT_C_AML",
              breakdown = "subnational",
              surveyYearStart = 2016,
              returnGeometry = TRUE,
              f = "geojson")

# Convert the retrieved data to JSON format
m <- geojsonio::as.json(d2)

# Convert the JSON data to a spatial object
nc2 <- geojsonio::geojson_sp(m) 

# Define the color palette using the "viridis" color scale without log scale
pal <- leaflet::colorNumeric("viridis", domain = nc2$Value, na.color = "grey50")

# Plot the data using leaflet
leaflet(nc2[nc2$IndicatorId == "ML_FEVT_C_AML", ]) %>%
  # Add base map tiles
  addTiles() %>%
  # Add polygons to represent the regions
  addPolygons(
    stroke = TRUE,  # Add stroke to polygons
    color = "lightgrey",  # Set the border color to light grey
    weight = 0.5,  # Set the border weight
    smoothFactor = 0.3,  # Set the smooth factor for better rendering
    fillOpacity = 0.8,  # Set fill opacity
    fillColor = ~pal(Value),  # Fill polygons based on Value using the defined palette
    # Add labels to the polygons with characteristic label and value
    label = ~paste0(CharacteristicLabel, ": ", formatC(Value, big.mark = ",")),
    labelOptions = leaflet::labelOptions(
      style = list("font-weight" = "bold", "color" = "black"),  # Style the label text
      textsize = "13px",
      direction = "auto"
    )
  ) %>%
  # Add a legend to the map
  addLegend(
    pal = pal,  # Use the defined palette
    values = ~Value,  # Set the values for the legend
    opacity = 1.0,  # Set the opacity of the legend
    title = "Malawi: children with fever who took antimalarial drugs (%)",  # Set the title of the legend
    position = "bottomright",  # Position the legend at the bottom right
    labFormat = labelFormat()  # Format the labels
  ) %>%
  # Set the initial view of the map to focus on Malawi
  setView(lng = 37, lat = -13, zoom = 5.5)

```
:::

::: {.callout-note collapse="true"}
## How to model this data?

```{r}
#| include: false
#| message: false
#| warning: false

library("knitr")
library(tidyverse)
library(rdhs)

knitr::opts_chunk$set(echo = T, cache = T, warning = F, message = F, fig.pos = 'H', cache = T)
options(digits=4, scipen = 9)
```

Including DHS data in modelling could be using known values to estimate their impact on transmission. For instance, a user could obtain the relevant DHS data (e.g. ITN access and usage rates) from the survey indicators, and estimate the effective coverage in a particular country.

To do this we make a few assumptions and state them explicitly. We assume:

-   Survey year correlates with net distribution, and access to mosquito nets in any given household is a result of distribution in a given year.

-   Net usage remains consistent until a new survey is conducted.

-   Net functionality and effectiveness wanes annually, and they are considered lost/expired after three years.

-   Operational effectiveness accounts for factors such as the peak biting hours of a particular vector versus the time actually spent under the net. In some communities people spend their evenings at cuca shops or other informal outdoor settings, leaving them vulnerable to outdoor biting from exophagic vectors.

```{r}
#| message: false
#| warning: false

# ITN example

#source("theme_health_radar.R")
library(tidyverse)
library(rdhs)

# Get the country codes of the elimination 8 countries
all_countries = dhs_countries(returnFields=c("CountryName","DHS_CountryCode"))
elim8 = c("Botswana", "Namibia", "South Africa", "Eswatini", "Zambia", "Zimbabwe", "Mozambique", "Malawi")

# Get the country codes of the elimination 8 countries
e8_codes = all_countries[all_countries$CountryName %in% elim8, "DHS_CountryCode"]

## Source ITN coverage and usage data

indicators <- dhs_indicators()
all_malaria_indicators <- indicators |> 
  filter(Level1 == "Malaria") |> 
  select(c("IndicatorId", "Definition"))

# Select indicators

# ML_NETP_H_IT2: Percentage of households with at least one insecticide-treated mosquito net (ITN) for every two persons who stayed in the household the previous night
# ML_ITNU_N_ITN: Percentage of existing insecticide treated nets used the night before the survey

access_data <- dhs_data(indicatorIds = "ML_NETP_H_IT2",
                  countryIds = e8_codes,
                  surveyYearStart = 2000)

usage_data <- dhs_data(indicatorIds = "ML_ITNU_N_ITN",
                          countryIds = e8_codes,
                          surveyYearStart = 2000)

# Filter the data for Mozambique 

years <- access_data |> 
  filter(CountryName == "Mozambique") |>
  pull(SurveyYear) 

itn_access <- access_data |>
  filter(CountryName == "Mozambique", SurveyYear %in% years) |>
  arrange(SurveyYear) |>
  select(SurveyYear, Value) |> 
  complete(SurveyYear = full_seq(SurveyYear, 1), fill = list(Value = 0)) |> # assume other years to be zero
  pull(Value)

itn_use <- usage_data |>
  filter(CountryName == "Mozambique", SurveyYear %in% years) |>
  arrange(SurveyYear) |>
  select(SurveyYear, Value) |> 
  complete(SurveyYear = full_seq(SurveyYear, 1)) |> # usage remains consistent
  fill(Value, .direction = "down") |> 
  pull(Value)
  
# Assumptions
itn_eff <- c(0.95, 0.90, 0.85) # Annual ITN attrition/loss in physical and chemical effectiveness
opp_eff <- 0.5 # Operational effectiveness of ITN at reducing transmission

```

To demonstrate a loss in net functionality and effectiveness as they degrade and undergo attrition, the user can use the concept of convolution to represent a reduction in net access in the population. The initial series of values (net access) is reduced by another series of values (net effectiveness) at each time step by "filtering" the initial series through the reducing series. For example,

-   one year of net access and usage results in 5% loss,

-   two years result in 10% loss, and

-   three years result in 15% loss.

Ninety five percent (95%) of nets received in year one will remain at the end of the year. At the end of year two, we have 95% of nets received in year two, as well as 90% of the nets previously received in year one. In year three, 95% of any new nets will remain, 90% of the nets received in year two, and 85% of the nets previously received in year one. After four years, 0% of the nets received in year one remain, as well as 90% and 85% of nets received in years two and three, respectively.

```{r}
# Calculate coverage as loss in access by reductions in ITN effectiveness
itn_cov <- convolve(itn_access/100, rev(itn_eff), type = "open")
itn_cov <- itn_cov[1:length(itn_access)]  # Match the length of the distribution data
itn_cov_rounded <- round(itn_cov, 3)
```

Coverage is considered effective if it means the minimum access of one net per two persons, the net is used the night prior to the survey, and is operationally effective at preventing bites from an infectious mosquito. This represents the proportion of people who are protected from ongoing transmission.

```{r}

# Number of people with access effectively covered by available ITNs
eff_cov <- itn_cov_rounded * (itn_use/100) * opp_eff

# Create a data frame for the plot
itn_data <- data.frame(
  Year = full_seq(years, 1),
  Effective_Coverage = eff_cov 
)

# Create the ITN coverage plot
ggplot(itn_data, aes(x = Year, y = Effective_Coverage)) +
  geom_line() +
  labs(
    title = "Effective ITN Coverage in Mozambique",
    subtitle = "Malaria prevention through distribution and use of ITNs",
    x = "Survey Year",
    y = "People Protected (%)",
    caption = "Source: DHS Data API - Malaria Indicators ML_NETP_H_IT2 & ML_ITNU_N_ITN"
  ) +
  #theme_health_radar() +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 10)) +
  scale_x_continuous(breaks = years) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent)


```

In epidemiology, the measure of intensity of disease transmission is also known as the force of infection. Simply put, this is the rate at which susceptible individuals become infected per unit time. Three main factors determine this: the proportion of the mosquito population that is infectious, the contact rate between infectious mosquitoes and susceptible humans, and the probability that a bite from an infectious mosquito transmits disease to a susceptible human. The same applies with respect to infectious humans and susceptible mosquitoes. Mosquito nets are intended to prevent transmission by reducing the contact rate between humans and mosquitoes, and we assume that the population that is effectively covered by a mosquito net is no longer vulnerable to disease. As such, the force of infection, typically denoted by lambda ($λ$), now excludes those protected by the mosquito nets.

```{r}
#| eval: false

## To reduce transmission in disease model

lambda <- 0.7 # Force of infection
new_lambda <- lambda * (1-eff_cov)
```
:::

