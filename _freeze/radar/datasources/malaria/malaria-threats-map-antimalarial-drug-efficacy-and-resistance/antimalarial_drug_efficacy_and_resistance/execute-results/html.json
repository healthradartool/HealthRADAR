{
  "hash": "9820df9fd75c0323e3f163b719f0b8e6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Antimalarial drug efficacy and drug resistance\"\ndescription: \"The global database on antimalarial drug efficacy and resistance, established in 2000, tracks drug efficacy in malaria-endemic countries.\"\ndate: 09/27/2024 # mm-dd-yyyy\nimage: \"images/malaria_threats_map_antimalarial_efficacy_and_resistance.png\"\n\ncategories:\n  - entomology\n  - therapeutic efficacy studies\n  - molecular marker studies\n  - ongoing therapeutic efficacy studies\n  - ongoing molecular marker studies\n---\n\n\n\n\n::: {.page-tabs .panel-tabset}\n## Overview\n\n<h2>About the data</h2>\n\nThe global database on antimalarial drug efficacy and resistance was initiated in 2000 to centralize data and facilitate reporting on the status of antimalarial drug efficacy in malaria endemic countries.\n\nThe WHO global database on antimalarial drug efficacy and resistance contains data from therapeutic efficacy studies (TES) conducted on *P. falciparum*, *P. vivax*, *P. ovale*, *P. malariae* and *P. knowlesi*, as well as molecular marker studies of *P. falciparum* drug resistance. TES are mainly done using first- and second-line treatment as well as treatments considered for introduction into the treatment policy.\n\nThe datasets cover the period from 2010 to 2023. The data is based on antimalarial drug efficacy which is being monitored through therapeutic efficacy studies (TES) across Africa, Asia and South America. The TES track clinical and parasitological outcomes among patients receiving antimalarial treatment. TES are considered the gold standard by which countries can best determine their national treatment policies.\n\n**Molecular markers of antimalarial drug resistance data**\n\nThe database also includes data on the geographical distribution of molecular markers associated with *P. falciparum* drug resistance, including:\n\n-   *PfKelch13* (artemisinin resistance)\n-   *Pfplasmepsin 2-3* copy number (piperaquine resistance)\n-   *Pfmdr1* copy number (mefloquine resistance)\n-   *Pfcrt* in Mesoamerica (chloroquine resistance)\n\n<h2>Accessing the data</h2>\n\nData on TES performed in compliance with the WHO standard protocol for tracking the effectiveness of antimalarial drugs are included inthe database.The year in the database is the year the study started,since study durations frequently span two calendar years. Polymerase chain reaction (PCR) correction is employed in studies with a minimum follow-up duration of 28 days to differentiate treatment failures resulting from recrudescence from reinfection.\n\nThe protocol approach is used to calculate treatment failure rates. Only patients who finish the whole trial follow-up and have a definite outcome—a therapy failure or success—are included in this analysis. Patients who discontinue their participation in the trial, do not follow up, or withdraw are not included in the analysis. Treatment failure rates using the Kaplan-Meier analysis are provided when available.\n\n- To access the data, click on this [link](https://apps.who.int/malaria/maps/threats) to access the [Malaria Threats Map](https://apps.who.int/malaria/maps/threats/) page\n- Click Download Data option\n- Select the theme on the Antimalarial drug efficacy and resistance\n- Select the dataset required\n- Data can be filtered according to `species`, `region`, `country`, `site` and `year` in which collected. \n- Follow the prompts to select and download data\n- The data is downloaded as an Excel file\n\nThe TES reports can be accessed using the links below:\n\n***Plasmodium falciparum***\n\n[Report in table format ](https://cdn.who.int/media/docs/default-source/malaria/treatment-failure-pf.pdf?sfvrsn=aeae993b_5)\n\n***Plasmodium knowlesi***\n\n[Report in table format ](https://cdn.who.int/media/docs/default-source/malaria/treatment-failure-pk.pdf?sfvrsn=3dc7d759_5)\n\n***Plasmodium malariae***\n\n[Report in table format ](https://cdn.who.int/media/docs/default-source/malaria/treatment-failure-pm.pdf?sfvrsn=13442825_5)\n\n***Plasmodium ovale***\n\n[Report in table format ](https://cdn.who.int/media/docs/default-source/malaria/treatment-failure-po.pdf?sfvrsn=21826566_5)\n\n***Plasmodium vivax***\n\n[Report in table format ](https://cdn.who.int/media/docs/default-source/malaria/treatment-failure-pv.pdf?sfvrsn=48243097_5)\n\nThe most recent report may not contain all years of estimates. \n\nThe website also provides access to maps on antimalarial drug efficacy and resistance. The maps allow you to explore individual studies and site-level data for all the threats. The maps are updated regularly and data up to site level is available for most countries. The maps allow you to generate graphs by clicking onto it.\n\nThe maps can be accessed on the [Malaria Threats Map](https://apps.who.int/malaria/maps/threats) website.\n\nThe website has [dashboards](https://apps.who.int/malaria/maps/threats/#/dashboards) that allows the end user to view summaries of the threats at different geographical levels. The data is available at country and area level. End users may select up to 5 countries/area per report.\n\n<h2>What does the data look like?</h2>\n\n**Description**\n\nData from the most recent TES are summarized in the reports. A comprehensive summary of treatment failure rates broken down by treatment and country is offered using the interactive reports. Therapeutic outcomes are assessed on the final day of the study (day 28, or day 42 for drugs with longer elimination half-lives). For infections appearing during follow-up, genotyping must be conducted to distinguish new infections from recrudescence.\n\nData are available for each country and annually. Some datasheets contain a few years of data, while others report data for the most recent year.\n\nA sample of the data is shown below. The table summarizes the treatment failure rates among patients infected with *P. malariae*. The displayed data is grouped by country and treatment.\n\n![](images/paginated_report.png)\n\nA sample of the map is shown below. The map details the area where the treatment failure rates among patients infected with *P. falciparum* and treated using *artemether-lumefantrine*.\n\n![](images/map.png)\n\nA sample of the dashboard is shown below. The dashboard details the area treatment failure rates by drug for South Africa, Eswatini and Mozambique. The dashboard provides a summary comparison across all countries selected.\n\n![](images/dashboard.png)\n\n<h2>Key points to consider</h2>\n\nThe website provides the users with various information related to Antimalarial drug resistance and can be assessed using various tools. The data and information is updated regularly. \n\n**Strengths**\n\n- The dataset is widely used and evaluated.\n- It provides a number of useful information for antimalarial drug efficacy.\n- It provides a number of useful variables for drug resistance. \n- Reports and Data are updated regularly.\n\n**Limitations**\n\n- The datasets have data on selected countries/areas affected by malaria only. \n- The most recent report may not contain all years of estimates. \n\n<h2>Terms of use</h2>\n\nThe various datasets on the website are provided for all to use with free access. Please acknowledge all sources by citing one or more of the papers referenced. The website can also be acknowledged.\n\n<h2>Examples of data use in literature</h2>\n\n- Adam M, Nahzat S, Kakar Q, Assada M, Witkowski B, Tag Eldin Elshafie A, et al. Antimalarial drug efficacy and resistance in malaria-endemic countries in HANMAT-PIAM_net countries of the Eastern Mediterranean Region 2016–2020: Clinical and genetic studies. Trop Med Int Health. 2023; 28(10): 817–829. https://doi.org/10.1111/tmi.13929\n\n- Kagoro, F.M., Allen, E., Mabuza, A. et al. Making data map-worthy—enhancing routine malaria data to support surveillance and mapping of Plasmodium falciparum anti-malarial resistance in a pre-elimination sub-Saharan African setting: a molecular and spatiotemporal epidemiology study. Malar J 21, 207 (2022). https://doi.org/10.1186/s12936-022-04224-4\n\n- Monroe A, Williams NA, Ogoma S, Karema C, Okumu F. Reflections on the 2021 World Malaria Report and the future of malaria control. Malar J. 2022 May 27;21(1):154. doi: 10.1186/s12936-022-04178-7. PMID: 35624483; PMCID: PMC9137259.\n\n- WHO,2009, Methods for surveillance of antimalarial drug efficacy [Publication Item](https://www.who.int/publications/i/item/9789241597531#:~:text=Overview,that%20have%20already%20been%20registered.)\n\n\n## Visualisations\n\n<h2>How to use this data?</h2>\n\nEvaluating trends in antimalarial drug resistance and communicating the results to a broad audience are important for dealing with the drug resistance threat.\n\nAs part of its normative function, WHO creates standard procedures to track the effectiveness, resistance, and prevention of antimalarial drugs and offers nations financial and technical support to put these protocols into practice. The [Malaria Threats Map](https://www.who.int/activities/monitoring-malaria-drug-efficacy-and-resistance#cms) is derived from a global database containing the findings of various investigations. Updates to national policies for first- and second-line therapies for malaria are also influenced by these studies.\n\nDownload the data from the link and read in a sheet. Sometimes the data needs to be prepared before it is able to be plotted. The data can be saved for use.\n\n<h2>How to plot this data?</h2>\n\nTo access the specific data used in the visualisations:\n\n1.  Navigate to the [Malaria Threats Map page](https://apps.who.int/malaria/maps/threats/)\n\n2.  Below the right-most window labelled 'Data Download', click on the 'DOWNLOAD DATA' button.\n\n3.  Select the 'Antimalarial drug efficacy and resistance' tile.\n\n4.  Select 'Therapeutic efficacy studies' from the dropdown menu.\n\n5.  Select 'ADD TO DOWNLOAD', and then select 'NEXT STEP'. Follow the prompts to download your file.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\nlibrary(EnvStats)\nlibrary(tidyverse)\nlibrary(rdhs)\nlibrary(ggrepel)\nlibrary(sf)\nlibrary(rnaturalearth)\nlibrary(rnaturalearthdata)\nlibrary(whowmr)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(tidyr)\nlibrary(forcats)\nsource(here::here(\"radar/theme_health_radar.R\"))\n\n# Define the elimination 8 countries\ne8_countries <- c(\"Botswana\", \"Eswatini\", \"Namibia\", \"South Africa\", \"Angola\", \"Mozambique\", \"Zambia\", \"Zimbabwe\")\n\n# Read data from an Excel file, specifically from the \"Data\" sheet\ndata <- readxl::read_xlsx(\"data/MTM_THERAPEUTIC_EFFICACY_STUDY_20241216.xlsx\",\n                          sheet = \"Data\")\n\n# Convert specific columns to numeric type\ndata$`POSITIVE_DAY_3 (days)` <- as.numeric(data$`POSITIVE_DAY_3 (days)`)\ndata$TREATMENT_FAILURE_PP    <- as.numeric(data$TREATMENT_FAILURE_PP)\ndata$TREATMENT_FAILURE_KM    <- as.numeric(data$TREATMENT_FAILURE_KM)\n\n# Reshape the data from wide to long format, selecting columns 12 to 16\ndat_long <- data |> \n  pivot_longer(12:16, names_to = \"Indicator\", values_to = \"Value\") |> \n  filter(COUNTRY_NAME %in% e8_countries)  # Filter rows to include only E8 countries\n\n# Filter the long data for treatment failure per protocol (PP)\ndat_trt_pp <- dat_long |> filter(Indicator == \"TREATMENT_FAILURE_PP\")\n\n# Filter the long data for sample size\ndat_sample <- dat_long |> filter(Indicator == \"SAMPLE_SIZE\")\n```\n:::\n\n\n\n\nA stacked bar plot is a useful way of visualising a total value that is made up of a number of contributions. Here, the total number of patients that completed a MTM therapeutic efficacy study per year between 2010 and 2021 are visualised, with the contributions from each of four of the E8 countries highlighted.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Number of individuals that completed a study in the e8 countries in a given year\nggplot(dat_sample, aes(x = YEAR_END, y = Value, fill = COUNTRY_NAME)) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  # Apply the custom fill scale for Country\n  scale_fill_manual_health_radar() +  \n  # Apply the custom radar theme\n  theme_health_radar() + \n  # Center title\n  theme(plot.title.position = \"plot\") +\n  # Add labels and title to the plot\n  labs(\n    title = \"Number of patients that completed a MTM therapeutic efficacy study \\n (2010-2021)\",\n    y = \"Number of Patients\",\n    x = \"Year\",\n    fill = \"Country\",\n    caption = str_wrap(\"The number of patients that completed a Malaria Threats Map Therapeutic Efficacy Study between 2010 and 2021, for any drug. This excludes all patients that withdrew or were lost to follow-up. Contributions vary by country and year, with Zimbabwe having the highest number of patients complete the study for any year in 2010 (768 patients), and the most patients completing the study across E8 countries in 2015 (1039 patients). Source: Malaria Threats Map Therapeutic Efficacy Study.\", width = 85)\n  ) \n```\n\n::: {.cell-output-display}\n![](antimalarial_drug_efficacy_and_resistance_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\nThe percentage of patients who experienced treatment failure at different Zimbabwean sites can be visualised using a faceted bar plot.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter the data for Zimbabwe only, and remove sites Gokwe and Chiredzi - missing data\nfilt_data = dat_trt_pp |> filter(COUNTRY_NAME == \"Zimbabwe\" & !(SITE_NAME %in% c(\"Gokwe\", \"Chiredzi\")), DRUG_NAME == \"Artemether-lumefantrine\")\n# Define a single color for the bars\nsingle_color <- \"#1b9e77\"\n\n# Plot the data as a bar plot\nggplot(filt_data, aes(x = as.factor(YEAR_END), y = Value, fill = single_color)) +\n  # Create bar plot with no legend\n  geom_bar(stat = \"identity\", position = \"dodge\", show.legend = FALSE) + \n  # Use the health radar color scheme\n  scale_fill_manual_health_radar() +\n  # Set y-axis ticks to increment by 2\n  scale_y_continuous(breaks = seq(0, max(filt_data$Value, na.rm = TRUE), by = 2)) +  \n  # Facet the plot by SITE_NAME, creating 6 subplots\n  facet_wrap(~ SITE_NAME) +\n  # Apply the health radar theme\n  theme_health_radar() +\n  # increase separation between panels\n  theme(panel.spacing = unit(1, \"lines\")) +\n  # Add titles and labels\n  labs(\n    title = \"Percentage of patients with treatment failure (2010, 2014 and 2017)\",\n    x = \"Year\",\n    y = \"Percentage of Patients\",\n    caption = str_wrap(\"The percentage of patients with treatment failure in Artemether-lumefantrine drug trials ending in the years 2010, 2014 and 2017, for trials run at selected sites in Zimbabwe. Note that the y-axis ranges from 0% to 9.1%. This maximum percentage of patients with treatment failure (9.1%) occurs at the Beitbridge site in 2010. At least one trial is completed at each site with an observed treatment failure of 0%. It should be noted that the number of patients who completed each trial differs drastically between trials, with the minimum being 13 at the Uzumba-Maramba-Pfungwe site in 2017, and the maximum being 109 participants at the Mutasa site in 2010. This impacts the probability of observing a patient with treatment failure. Source: Malaria Threats Map Therapeutic Efficacy Study.\", width = 100))\n```\n\n::: {.cell-output-display}\n![](antimalarial_drug_efficacy_and_resistance_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Is the treatment working nearly perfectly, or is there some other factor potentially at play with a number of sites having treatment failure of 0% in 2017? There is no missing data (i.e. these aren't NaNs), and the sample sizes range between 13 and 103, so they are mostly respectable. I feel like I may have missed a mitigating factor which should be mentioned in the caption\n```\n:::\n\n\n\n\nA lollipop plot can be used to visualise the percentage of patients who experienced treatment failure on different drugs, in different countries. A problem is encountered, however, if multiple trials in the same country had the same percentage of patients with treatment failure. Jittering is used to solve this problem, which decreases the visual appeal but ensures that important information is not obscured.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(stringr)\n\n# Set seed to ensure identical jittering every time the plot is built\nset.seed(18)\n\ndat_trt_pp |> \n  # Filter the data to include only rows where Value is not NA and YEAR_END is 2015\n  filter(is.na(dat_trt_pp$Value) == FALSE, YEAR_END == 2015) |>\n  # Create ggplot object with the filtered data\n  ggplot(aes(x = fct_reorder(COUNTRY_NAME, Value, .na_rm = FALSE),  # Reorder COUNTRY_NAME based on Value\n                          y = Value,             # Set y-axis to Value\n                          color = DRUG_NAME)) +  # Color points by DRUG_NAME\n  # Add grey segments from y=0 to the value for each country\n  geom_segment(aes(x = COUNTRY_NAME, xend = COUNTRY_NAME, y = 0, yend = Value), color = \"grey\") +  \n  # Add jittered points to the plot, sized at 4\n  geom_jitter(size = 4, height = 0, width = 0.2) +\n  # Flip the coordinates for a horizontal bar plot\n  coord_flip() +  \n  # Apply custom color scale\n  scale_colour_manual_health_radar() +\n  # Apply custom theme\n  theme_health_radar() +\n  # Shift the title position\n  theme(plot.title.position = \"plot\") +\n  # Add labels and title to the plot\n  labs(\n    title = \"Percentage of patients with treatment failure (2015)\",\n    caption = str_wrap(\n      \"The percentage of patients with treatment failure in trials ending in the year 2015, in selected E8 countries, highlighting the drug which was being tested. Note that the x-axis ranges from 0% to 13.6%. Each country has at least two trials which showed no evidence of treatment failure. The highest percentage of patients who experienced treatment failure (13.6%) was observed in an Angolan trial for the drug Artemether-lumefantrine. It should be noted that the number of patients who completed each trial differs drastically between trials, with the minimum being 56 at an Angolan site trialing the drug Artesunate-amodiaquine, and the maximum being 145 participants at a Zambian site trialing the drug Artemether-lumefantrine. This impacts the probability of observing a patient with treatment failure. Source: Malaria Threats Map Therapeutic Efficacy Study.\", \n      width = 65),\n    x = \"\",\n    y = \"Percentage\", \n    colour = \"Drug\")\n```\n\n::: {.cell-output-display}\n![](antimalarial_drug_efficacy_and_resistance_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Modelling  \n\n<h2>How can this data be used in disease modelling?</h2>\n\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\n\nTherapeutic efficacy studies assess how well antimalarial drugs clear infections and are an indicator of treatment success. Case management with Artemisinin-based Combination Therapy (ACTs) is a critical part of any country's control strategy, and as such, representing it accurately in the disease model is key. Twenty therapeutic efficacy studies following treatment with Artemether-lumefantrine were done in Zimbabwe between 2010 and 2017. We use these to inform the treatment dynamics in the health system.\n\n### Preparing the data\n\nWe calculate the mean probability of treatment failure in each year to inform the model.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the data\ntherapeutic_eff_data <- read_excel(\"data/MTM_THERAPEUTIC_EFFICACY_STUDY_20250324.xlsx\",\n           sheet = 2) |>  \n  mutate(TREATMENT_FAILURE_PP = as.numeric(TREATMENT_FAILURE_PP)/100)\n\n# Calculate mean probability of treatment failure over time\nmean_pf <- therapeutic_eff_data |> \n  group_by(YEAR_END) |> \n  summarise(mean = mean(TREATMENT_FAILURE_PP)) |>  \n  mutate(time = c(365*10, 365*15, 365*18)) # to get time series for 2010, 2014 and 2017 with simulation beginning in 2000\n\ntherapeutic_eff_data |>  \n  ggplot(aes(x = as_factor(YEAR_END), y = TREATMENT_FAILURE_PP)) +\n  geom_boxplot(aes(colour = as.factor(YEAR_END)), outlier.shape = NA) +\n  stat_summary(aes(colour = \"Mean\"), fun = mean) +\n  geom_jitter(aes(colour = as.factor(YEAR_END)), width = 0.15) +\n  scale_y_continuous(labels = scales::percent) +\n  theme_health_radar() +\n  scale_colour_manual_health_radar() +\n  labs(title = \"Patients with treatment failure in Zimbabwe\",\n       subtitle = str_wrap(\"Data from 20 Therapeutic Efficacy Studies\"),\n       x = \"Year\",\n       y = \"Proportion that failed treatment\",\n       colour = \"Year and Variable\", \n       caption = str_wrap(\"Median and Interquartile values from study results indicated by boxplot. We see that mean treatment failure is decreasing over time, from 3% in 2010 to almost 0% in 2017. Source: Malaria Threats Map.\"))\n```\n\n::: {.cell-output-display}\n![](antimalarial_drug_efficacy_and_resistance_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\n### Model assumptions\n\nUsing a simple model, we demonstrate how treatment failure is incorporated, and plot the values for incidence. We start with the time-dependent parameter $pf(t)$ for treatment failure among patients infected with *Plasmodium falciparum* in Zimbabwe. We assume that patients are treated, experience treatment failure and express clinical symptoms again within the study follow up period of 28 days (see parameters for $r$ and $sigma$).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Time points for the simulation\nY = 22 # Years of simulation\ntimes <- seq(0, 365*Y, 1) # time in days\n\n# Create a time-dependent function for treatment failure\npf_function <- approxfun(mean_pf$time, mean_pf$mean, rule = 2)  # linear interpolation\n\n# Define basic dynamic Human-static Vector model ####\nseirs <- function(times, start, parameters, pf_function)  {\n  with(as.list(c(parameters, start)), {\n    P = S + E + A + C + Tr + Tf + R + G\n    \n    # Seasonality\n    seas.t <- amp*(1+cos(2*pi*(times/365 - phi)))\n    \n    # Force of infection\n    Infectious <- C + Tf + zeta_a*A + zeta_t*Tr # infectious reservoir\n    lambda = ((a^2*b*c*m*Infectious/P)/(a*c*Infectious/P+mu_m)*(gamma_m/(gamma_m+mu_m)))*seas.t\n    \n     pf_t <- pf_function(times)\n\n    # Differential equations/rate of change\n    \n    dS = mu_h*P - lambda*S + rho*R - mu_h*S\n    dE = lambda*S - (gamma_h + mu_h)*E\n    dA = pa*gamma_h*E + pa*gamma_h*G +omega*C - (delta + mu_h)*A\n    dC = (1-pa)*gamma_h*E + (1-pa)*gamma_h*G + sigma*Tf - (tau + omega + mu_h)*C\n    dTr = tau*C - (r + mu_h)*Tr\n    dTf = pf_t*r*Tr - (sigma + mu_h)*Tf\n    dR = delta*A + (1-pf_t)*r*Tr - (lambda + rho + mu_h)*R\n    dG = lambda*R - (gamma_h + mu_h)*G\n     \n    dCInc = lambda*(S+R)\n    \n    output <- c(dS, dE, dA, dC, dTr, dTf, dR, dG, dCInc)\n    list(output)\n  })\n}\n\n# Input definitions ####\n\n#Initial values\nstart <- c(S = 550000, # susceptible humans\n           E = 300000, # exposed and infected humans\n           A = 150000, # asymptomatic and infectious humans\n           C = 155000, # clinical and symptomatic humans\n           Tr = 80000, # treated humans\n           Tf = 20000, # treated humans that have had treatment failure\n           R = 200000, # recovered and semi-immune humans\n           G = 155000, # secondary-exposed and infected humans\n           CInc = 0 # cumulative incidence           \n           ) \n\n\n# Parameters\nparameters <- c(a = 0.28, # human feeding rate per mosquito\n           b = 0.3, # transmission efficiency M->H\n           c = 0.3, # transmission efficiency H->M\n           m = 3, # mosquito-human ratio\n           gamma_m = 1/10, # rate of onset of infectiousness in mosquitoes\n           mu_m = 1/12, # natural birth/death rate in mosquitoes\n           mu_h = 1/(59*365), # natural birth/death rate in humans\n           gamma_h = 1/12, # rate of onset of infectiousness in humans\n           r = 1/7, # rate of loss of infectiousness after treatment\n           rho = 1/365, # rate of loss of immunity after recovery\n           delta = 1/150, # natural recovery rate\n           omega = 1/10, # rate of loss of symptoms in untreated clinical infection\n           zeta_a = 0.2, # relative infectiousness of asymptomatic infections\n           zeta_t = 0.1, # relative infectiousness of treated infections\n           tau = 1/3, # treatment seeking rate\n           sigma = 1/21, # rate of symptomatic recurrence after treatment failure\n           pa = 0.35, # probability of asymptomatic infection\n           #pf = 0.0228, # probability of treatment failure\n           amp = 0.45, # amplitude\n           phi = 200 # phase angle; start of season\n)\n\n# Run the model\nout <- ode(y = start, \n           times = times, \n           func = seirs, \n           parms = parameters,\n           pf_function = pf_function)\n\n\n# Post-processing model output into a dataframe\n\ndf <- as_tibble(as.data.frame(out)) |> \n  mutate(P = S + E + A + C + Tr + Tf + R + G,\n         Inc = c(0, diff(CInc)),\n         TsR = Tr/(Tr+Tf)) |> \n  pivot_longer(cols = -time, names_to = \"variable\", values_to = \"value\") |> \n  mutate(date = ymd(\"2000-01-01\") + time)\n\ndf |> \n  filter(variable %in% c(\"TsR\"), date > ymd(\"2009-06-01\")) |> \n  ggplot() +\n  geom_line(aes(x = date, y = value, colour = variable)) +\n  theme_health_radar() +\n  scale_colour_manual_health_radar() +\n  scale_y_continuous(labels = scales::percent, limits = c(0, NA)) +\n  labs(\n    title = \"Treatment success rate\", \n    subtitle = \"Treatment successes divided by total treatment\",\n    x = \"Year\",\n    y = \"Percentage\",\n    caption = str_wrap(\"In general, treatment follows the seasonal pattern of malaria, but the treatment success rate has an overall increasing trend as treatment failure decreases over time, and more infected individuals are successfully cured. Source: Model output\")) +\n  theme(guides = \"none\")\n```\n\n::: {.cell-output-display}\n![](antimalarial_drug_efficacy_and_resistance_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n### Exploring uncertainty\n\nTo account for the uncertainty in the probability of treatment failure $pf$, we sample the value from a triangular distribution and explore the range of the runs.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(triangle)\nlibrary(lhs)\n\n\nset.seed(123)\nruns <- 50\nresults_list <- vector(\"list\", runs)\n\n# Latin Hypercube Sample matrix across 3 years for 50 runs\nlhs_matrix <- randomLHS(runs, 3)\n\n# Run simulations\nfor (i in 1:runs) {\n  \n  # Summarise treatment failure stats by year\n  # Assume mode to be the mean for triangular distribution sampling\n  pf_data <- therapeutic_eff_data |> \n    group_by(YEAR_END) |> \n    summarise(\n      min = min(TREATMENT_FAILURE_PP), \n      mode = mean(TREATMENT_FAILURE_PP),\n      max = max(TREATMENT_FAILURE_PP),\n      .groups = \"drop\"\n    )\n  \n  # Time durations (in days) from start of simulation\n  # Sample values probability of treatment failure from a triangular distribution for each year\n  pf_data <- pf_data |> \n    mutate(time = c(365*5, 365*10, 365*13))\n  \n  # Use LHS to sample from triangular distribution\n  pf_values <- pf_data |> \n    mutate(pf_sampled = map2_dbl(row_number(), mode, \n                                 ~ qtri(lhs_matrix[i, .x], \n                                        min = min[.x], \n                                        mode = .y, \n                                        max = max[.x])))\n  \n  # Time-dependent interpolation for sampled values\n  pf_run_function <- approxfun(pf_values$time, pf_values$pf_sampled, rule = 2)\n  \n  # Run the ODE\n  sens_out <- ode(y = start,  \n           times = times, \n           func = seirs, \n           parms = parameters,\n           pf_function = pf_run_function)\n  \n  # Store and tidy output\n  results_list[[i]] <- as_tibble(as.data.frame(sens_out)) |> \n    mutate(P = S + E + A + C + Tr + Tf + R + G,\n           Inc = c(0, diff(CInc)),\n           TsR = Tr/(Tr+Tf)) |> \n    pivot_longer(cols = -time, names_to = \"variable\", values_to = \"value\") |> \n    mutate(date = ymd(\"2004-01-01\") + time,\n           run = i)\n}\n\n# Combine all runs into one dataframe\nsens_df <- bind_rows(results_list)\n\nmedian_sens <- sens_df |> \n  group_by(time) |> \n  filter(variable == \"TsR\") |> \n  summarise(median = median(value), \n            lower = quantile(value, 0.05),\n            upper = quantile(value, 0.95),\n            .groups = \"drop\") |> # plot median values and 95% confidence intervals\n  mutate(date = ymd(\"2000-01-01\") + time)\n\nsens_df |> \n  filter(variable == \"TsR\", date > ymd(\"2009-06-01\")) |> \n  ggplot() +\n  # geom_line(aes(x = date, y = value, colour = as_factor(run), group = run), alpha = 0.5) + # if you want to see individual runs\n  geom_ribbon(data = median_sens |> filter(date > ymd(\"2009-06-01\")), aes(x = date, ymin = lower, ymax = upper), \n              fill = theme_health_radar_colours[12], alpha = 0.5) +\n  geom_line(data = median_sens |> filter(date > ymd(\"2009-06-01\")), aes(x = date, y = median, linetype = \"Median\"), linewidth = 0.5) +\n  theme_health_radar() +\n   scale_y_continuous(labels = scales::percent, limits = c(0, NA)) +\n  labs(\n    title = \"Treatment success rate\", \n    subtitle = \"Shaded area shows 5–95% range across 50 model runs.\",\n    x = \"Year\",\n    y = \"Percentage\",\n    caption = str_wrap(\"Sensitivity analysis of values for treatment failure in each year. Sampling from within the minimum and maximum ranges provided does not appear to significantly cause changes to the treatment success rate. Source: Model output.\")) +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](antimalarial_drug_efficacy_and_resistance_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\n### Policy implications\n\nTreatment failure and antimalarial drug resistance can lead to prolonged infectious periods, recrudescence, or higher onward transmission, all of which increase the burden on the health system. Policymakers may need to evaluate the performance of first- and second-line therapies based off of surveillance and other insights from therapeutic efficacy studies, and perhaps recommend changes to treatment guidelines such as the use of triple ACTs or monotherapies.\n\n:::\n",
    "supporting": [
      "antimalarial_drug_efficacy_and_resistance_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}