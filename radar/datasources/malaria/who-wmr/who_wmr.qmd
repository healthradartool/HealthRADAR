---
title: "World Malaria Report"
description: "The report provides a comprehensive and up-to-date assessment of trends in malaria control and elimination across the globe."
date: 07/03/2024 # mm-dd-yyyy
image: "images/wmr-covers-2023.jpg"
lightbox: true # for images
execute:
  message: false
  warning: false

language: 
  title-block-published: "Last updated"
  
page-layout: full
title-block-banner: "#EDF3F9"
title-block-banner-color: "#212529"
categories:
  - malaria
  - epidemiology
  - interventions
  - country-level
  - annual
---

```{r setup, include=FALSE}
source(here::here("radar/datasources/malaria/who-wmr/scripts/packages.R"))
#devtools::install_github("uct-masha/whowmr")
```

::: {.page-tabs .panel-tabset}

## Overview

<h2>About the data</h2>

The WHO World Malaria report, released on an annual basis, provides a comprehensive and up-to-date assessment of trends in malaria control and elimination across the globe. The annexes to the report provide useful information on the data sources and methods used to compile the World Malaria Report, a set of regional malaria profiles and tables of historical time series of case data, commodity distribution, funding amounts and policy adoption.

These datasets provide information on long term trends in malaria control and enable comparison between countries. The data provided are on an annual time scale at the national level, and would not be suitable for subnational analysis or to explore seasonal trends in malaria.


<h2>Accessing the data</h2> 


The reports can be accessed on the [WHO website](https://www.who.int/teams/global-malaria-programme/reports). Each report has a web page which includes useful contextual information as well as additional resources. The “Annexes in Excel format” will download as a zip file which should be extracted. The annexes can be viewed in the original report in PDF format, though for modelling it is usually preferable to have an excel spreadsheet.

The most recent report may not contain all years of estimates. Should earlier years be required, one can access the annexes from earlier reports and merge these.

<h2>What does the data look like?</h2> 

**Description**

The list of annexes may vary annually. The information included typically looks like this. Data are available for each country and annually. Some datasheets contain a few years of data, while others report data for the most recent year. To make a longer time series of data, you can access older world malaria reports and annexes from the WHO. Be careful to check the data definitions and information on methodology to be sure that data sets can be concatenated.

The annexes can be found in the report itself as in the following examples:

![](images/annex4F.png "WHO World Malaria Report 2023 Annex 4F")

![](images/annex4H.png "WHO World Malaria Report 2023 Annex 4H")

The annexes can also be downloaded as Excel documents from the report page.

|         |                                                                                                              |
|-----------------------|------------------------------------------------|
| Annex 1 | Data sources and methods                                                                                     |
| Annex 2 | Number of ITNs distributed through campaigns in malaria endemic countries                                    |
| Annex 3 | WHO Regional profiles                                                                                        |
| Annex 4 | Data tables and methods                                                                                      |
|         | A. Policy adoption                                                                                           |
|         | B. Antimalarial drug policy                                                                                  |
|         | C. Funding for malaria control                                                                               |
|         | D. Commodities distribution and coverage                                                                     |
|         | E. Household survey results                                                                                  |
|         | F. Population denominator for case incidence and mortality rate, and estimated malaria cases and deaths      |
|         | G. Population denominator for case incidence and mortality rate, and reported malaria cases by place of care |
|         | H. Reported malaria cases by method of confirmation                                                          |
|         | I. Reported malaria cases by species                                                                         |
|         | J. Reported malaria deaths                                                                                   |
|         | K. Methods for Tables A-D-G-H-I-J                                                                            |

: Example of the annex layout. This example is from the 2023 world malaria report. Note that the annexes are paired with the report and should be interpreted as such.

<h2>Key points to consider</h2> 

**Pitfalls of Annual Data:**

Using annual data for your analysis can lead to several pitfalls:

-   Seasonal variations: Annual data may not capture the seasonal patterns of malaria transmission, which can be influenced by factors such as rainfall, temperature, and vector abundance. This can lead to an over- or underestimation of the disease burden and the impact of interventions.

-   Temporal aggregation: Aggregating data annually may mask important short-term dynamics, such as outbreaks or the immediate impact of interventions.

**Reporting - Incidence vs. Prevalence Data:**

It is important to distinguish between incidence and prevalence data when performing your analysis:

-   Incidence data: Incidence refers to the number of new cases of malaria occurring in a population over a specified period. It provides information on the rate at which new infections occur and is more sensitive to changes in transmission dynamics.

-   Prevalence data: Prevalence refers to the proportion of the population that has malaria at a given point in time. It provides a snapshot of the disease burden but does not capture the rate of new infections.

**Difference between Policy and Implementation:**

There can be discrepancies between the intended policy for ITN distribution and the actual implementation on the ground. Consider the following:

-   Coverage: The planned ITN coverage may differ from the actual coverage achieved due to factors such as logistics, access to remote areas, and population acceptance.

-   Timing: The timing of ITN distribution campaigns may vary from the planned schedule. This can affect the impact of ITNs on malaria transmission, particularly if the distribution does not align with peak transmission seasons.

-   Effectiveness: The effectiveness of ITNs may differ from the ideal scenario due to factors such as improper usage, wear and tear, and insecticide resistance.

**National Level - Ignoring Spatial Heterogeneity:**

Modelling malaria transmission at a national level can overlook important spatial heterogeneities:

-   Regional variations: Malaria transmission can vary significantly between different regions within a country due to differences in climate, vector ecology, and socio-economic factors.

-   Local hotspots: Even within regions, there can be local hotspots of malaria transmission due to factors such as proximity to breeding sites, population density, and human behavior.

-   Population movement: The movement of people between different areas can introduce or reintroduce malaria parasites, affecting transmission dynamics.

**Examples of data use in literature**

The report came out on Jan 31, 2024, so there are not many studies that have used the data yet. However, here are a few that are either under review or have been published recently:

-   [Assessing the Therapeutic Efficacy of Artemether-Lumefantrine for Uncomplicated Malaria in Lagos, Nigeria: A Comprehensive Study on Treatment Response and Resistance Markers](https://doi.org/10.21203/rs.3.rs-3985557/v1)

-   [Design, synthesis and Anti-Plasmodial activity of Mortiamide-Lugdunin conjugates](https://doi.org/10.1016/j.bioorg.2024.107307)

## Working with the data

<h2>How to use this data?</h2>

For this example, the goal is to get the reported malaria deaths for the elimination 8 (E8) countries, but your specific analysis may require different data.

We can either manually download, unzip and read in annex 4J or use the `whowmr` package to access the data. 

::: callout-warning
The annexes contain references to footnotes. The `whowmr` package leaves these in the data - the idea being that one should engage with the footnote and proceed with context.
<br>
:::

After inspecting the data beforehand to understand how it is structured and whether there are any footnotes relevant to our analysis, we can display our data in a table as follows:

```{r}
# View Annex 4J of the 2023 World Malaria Report. Note that we remove the footnotes here.
# The gt package is used for better formatting, but this is optional.
whowmr::wmr2023$wmr2023j |>
  # Hide the footnotes
  mutate(Country=`Country/area` |> stringr::str_remove("\\d.*$")) |>
  select(Country, `2010`:`2022`) |>
  head() |>
  gt() |>
  tab_options(table.align = "left")
```

The E8 countries are Botswana, Eswatini, Namibia, South Africa, Angola, Mozambique, Zambia, and Zimbabwe. To filter the data for these countries, you can use the following code:

```{r}
# Define the E8 countries
e8_countries <- c("Botswana", "Eswatini", "Namibia", "South Africa", "Angola", "Mozambique", "Zambia", "Zimbabwe")

# Filter the data for the E8 countries
wmr2023j_e8 <- whowmr::wmr2023$wmr2023j |>
  filter(`Country/area` %in% e8_countries) |>
  rename(Country="Country/area") |>
  select(!`WHO Region`) # Remove the WHO Region column

# View the filtered dataset
gt(wmr2023j_e8)|>
  tab_options(table.align = "left")
```



<h2>How to plot this data?</h2>

```{r include=FALSE}

source(here::here("radar/theme_health_radar.R"))
wmr2023Ea_Africa <- whowmr::wmr2023$wmr2023ea |>
  transmute(Source = Source,
            ITNCovPercent = `% of population who slept under an ITN last night`/100,
            Country = as_factor(`Country/area`)) |>
  filter(Country %in% c("Benin", "Cameroon", "Ghana", "Kenya", "Mozambique", "Namibia", "Nigeria", "Zambia")) 


```

```{r}

library(stringr)

# Create the lollipop plot
ggplot(wmr2023Ea_Africa, aes(x = fct_reorder(Country, ITNCovPercent, .na_rm = FALSE),
                             y = ITNCovPercent,
                             color = Source)) +
  geom_segment(aes(x = Country, xend = Country, y = 0, yend = ITNCovPercent), color = "grey") +  # Keep constant grey color for segments
  geom_point(size = 4) +
  coord_flip() +  # Adjust the aspect ratio to make the plot taller
  scale_colour_manual_health_radar() +  # Correct color scale for the discrete 'Source' variable
  theme_health_radar() +
  labs(title = "Percentage of Households with at least one ITN",
       subtitle = "Data for selected African countries",
       caption = str_wrap("The percentage of households with at least one insecticide-treated net (ITN) in selected African countries, highlighting variations in ITN coverage. Benin,and Mozambique exhibit the highest coverage, while Kenya and Nigeria have the lowest. Most countries have coverage between 50% and 60%, which supports malaria control efforts if ITNs are properly used and resistance to insecticides remains low. Source: WMR 2023 Annex 4Ea.", width = 75),
       x = "Country",
       y = "Percentage") 

```


```{r}
library(ggrepel)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(whowmr)

# Define the elimination 8 countries
e8_countries <- c("Botswana", "Eswatini", "Namibia", "South Africa", "Angola", "Mozambique", "Zambia", "Zimbabwe")

# Load the map data for Africa
e8_africa <- ne_countries(continent = "Africa", returnclass = "sf") |>
  mutate(name = if_else(name=="eSwatini", "Eswatini", name)) |>
  filter(name %in% e8_countries)

# Merge the map data with your data
e8_data <- e8_africa |>
  left_join(wmr2023$wmr2023j |> mutate(), by = c("name" = "Country/area"))

# Create the choropleth map
ggplot(data = e8_data) +
  geom_sf(aes(fill = `2022`), color = "lightgrey", size = 0.3) +  # Use fill for the continuous 2022 data
  theme_health_radar() +
  scale_fill_continuous_health_radar(name = "Deaths") +  # Correct fill scale for continuous data
  labs(title = "Reported malaria deaths in the Elimination 8 countries (2022)",
       caption = str_wrap("The choropleth map highlights reported malaria deaths in the Elimination 8 countries in 2022, with Angola, Mozambique, and Zambia showing higher mortality rates. These reported figures may not reflect the full scale of malaria deaths due to potential underreporting and misclassification. Considering estimated deaths alongside reported figures would provide a more comprehensive picture. Source: WMR 2023 Annex 4J.", width = 80)
,
       x = "Latitude",
       y = "Longitude") +
  
  geom_sf_text(aes(label = name, color = ifelse(`2022` > mean(`2022`), "black", "white")), size = 3) +  # Conditional text color
  scale_color_identity() +  
  theme(
    plot.caption.position = "plot",  # Keep the caption outside the plot area
  )

```

```{r}

whowmr::wmr2023$wmr2023f |>
  # Filter for the frontline E8 countries
  filter(`Country/area` |> stringr::str_detect("Botswana|Eswatini|Namibia|South Africa"),
         # We couldn't get opt_interactive to work with grouped rows so we'll just display fewer columns
         Year>=2020) |>
  # Rename columns to something more readable
  rename(Country="Country/area", `Population at risk`="Population denominator for incidence and mortality rate") |>
  # Hide the footnotes
  mutate(Country=Country |> stringr::str_remove("\\d.*$")) |> 
  # Remove the WHO Region column
  select(!`WHO Region`) |>
  gt(
    groupname_col = "Country",
    row_group_as_column = TRUE
  ) |>
  tab_header(title="Population at risk and estimated malaria cases and deaths in the E8 frontline countries",
             subtitle="Data from WMR 2023 Annex 4F") |>
  # Control how NA values are displayed
  sub_missing(columns = everything(), missing_text = "-") |>
  # Group the Cases and Deaths columns and rename, eg, Cases_Lower to just Lower
  cols_label_with(columns = starts_with("Cases")|starts_with("Deaths"), fn=~stringr::str_remove_all(., ".+_")) |>
  tab_spanner(label="Cases", columns=starts_with("Cases")) |> 
  tab_spanner(label="Deaths", columns=starts_with("Deaths")) |>
  # Format the numbers to be more readable
  fmt_number(columns=c(`Population at risk`,starts_with("Cases")|starts_with("Deaths")), suffixing = T) |>
  # Country column should be bold:
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_row_groups()
  ) |>
  tab_style(
    style = cell_borders(
      sides = c("left"),
      weight = px(1)),
    locations = cells_body(
      columns = c(Year, `Population at risk`, Cases_Lower, Deaths_Lower)
    )
  ) |>
  tab_style(
    style = cell_borders(
      sides = c("right"),
      weight = px(1)),
    locations = cells_body(
      columns = c(Deaths_Upper)
    )
  )|>
  tab_options(table.align = "left")

```


```{r}
# Create the plot for Deaths with low and high bands
whowmr::wmr2023$wmr2023f |>
  # Filter for the E8 countries
  filter(`Country/area` |> stringr::str_detect("Angola|Botswana|Eswatini|Malawi|Mozambique|Namibia|South Africa|Zambia|Zimbabwe")) |>
  # Rename columns to something more readable
  rename(Country="Country/area", `Population at risk`="Population denominator for incidence and mortality rate") |>
  # Hide the footnotes
  mutate(Country=Country |> stringr::str_remove("\\d.*$")) |> 
  # Remove the WHO Region column
  select(!`WHO Region`) |> 
  ggplot(aes(x = Year, y = Cases_Point, group = Country, color = Country)) +
    geom_line(linewidth = 1) +
    geom_ribbon(aes(ymin = Cases_Lower, ymax = Cases_Upper, fill = Country), alpha = 0.2) +  # Corrected to use 'fill' for the ribbon
    scale_colour_manual_health_radar() +  # Apply manual color scale for 'color' aesthetic (lines)
    scale_fill_manual_health_radar() +    # Apply manual color scale for 'fill' aesthetic (ribbon fill)
    theme_health_radar() +
    labs(
      title = "Estimated Malaria Cases (2000-2022)",
      subtitle = "With confidence bands",
      x = "Year",
      y = "Number of Cases (thousands)",
      color = "Country",
      fill = "Country",  # Added 'fill' label for the ribbon shading
      caption = str_wrap("The plot displays estimated malaria cases in selected countries from 2000 to 2022, with lines representing case estimates and shaded areas showing the confidence bands. Variations in case numbers and uncertainty across countries are evident, such as stable case numbers in Mozambique, while Angola saw fluctuating cases with increasing uncertainty after 2015. Source: WMR 2023 Annex 4F.", width = 85)

    )

    
```


```{r}

# Read in the costing data
costing_df <- read_csv("tutorial_data/costing_df.csv")

# Reshape data for plotting
plot_df <- costing_df |>
  pivot_longer(cols = starts_with("Country_"), names_to = "Donor", values_to = "Amount") |>
  mutate(Donor = gsub("Country_", "", Donor)) # Remove "Country_" from the Donor names

# Set the order of the donors so that "Govt_NMP" is last
plot_df$Donor <- factor(plot_df$Donor, levels = c(
  "GlobalFund", "WorldBank", "PMI_USAID", "OtherBilaterals", 
  "WHO", "UNICEF","Govt_NMP", "OtherContributions"
))

# Create the plot
ggplot(plot_df, aes(x = Year, y = Amount / 1000, fill = Donor)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ Country, scales = "free_y") +
  scale_fill_manual_health_radar() +  # Apply the custom fill scale for 'Donor'
  labs(
    title = "Stacked Bar Plot of Country Contributions (2020-2022)",
    subtitle = "For Selected Countries",
    x = "Year",
    y = "Contributions (in thousands)",
    fill = "Donor",
    caption = str_wrap("The stacked bar plot shows donor contributions to malaria control efforts in selected countries from 2020 to 2022. Contributions vary by country and donor, with Mozambique receiving significant support from the Global Fund and PMI/USAID, while in South Africa, the Global Fund and local government are key contributors. Understanding the distribution of funding is essential for evaluating the sustainability and impact of malaria control programs. Source: WMR 2023 4C.", width = 100)
  ) +
  theme_health_radar()  # Apply the custom radar theme
  

```


<h2>How can this data be used in disease modelling?</h2>

### Preparing the data 

We obtain case data from Angola for the years 2000 to 2022. We use this data to calibrate our disease models, by fitting model outputs to observed data from the World Malaria Report. Throughout the calibration process we adjust the initial parameters we input into the model, making the model more accurate and representative of actual disease dynamics in a specific context. These parameters represent specific dynamics occurring the in the modelled context, for instance ITN usage $itn_{use}$ may be really high in Angola, or the dominant *Anopheles* vector may have a higher biting rate $a$. Country-specific parameter values should be obtained from existing datasets such as DHS surveys, published reports from national control programs and other stakeholders, literature review and expert knowledge. This data carries a level of uncertainty that may prevent the model from making accurate projections.

For this example, we fit a simple malaria model to incidence rates calculated from case data from Angola. 
While it is simpler to fit to case numbers, fitting to incidence rates allows us to capture the disease burden relative to a changing population size, and is better for comparing burden across different populations. Here, we calculate incidence rate per 1000 of the population at risk with the following formula: $$ Incidence.rate = \frac{Cases}{Population.at.risk} \times 1000 $$

```{r}
observed_data <- whowmr::wmr2023$wmr2023f |>
  # Filter for Angola
  filter(`Country/area` == "Angola") |>
  rename(Population_at_risk ="Population denominator for incidence and mortality rate") |>
  select(Year, Cases_Lower, Cases_Point, Cases_Upper, Population_at_risk) |> 
  # Calculate the incidence rate
  mutate(inci_rate = Cases_Point/Population_at_risk*1000,
         inci_rate_lower = Cases_Lower/Population_at_risk*1000,
         inci_rate_upper = Cases_Upper/Population_at_risk*1000) 

observed_data |> 
  ggplot() +
  #geom_pointrange(aes(x = Year, y = Cases_Point, ymin = Cases_Lower, ymax = Cases_Upper), colour = theme_health_radar_colours[15]) + # to see case numbers
  geom_pointrange(aes(x = Year, y = inci_rate, ymin = inci_rate_lower, ymax = inci_rate_upper), colour = theme_health_radar_colours[9]) +
  labs(title = "Malaria incidence rate in Angola from 2000 to 2022",
       subtitle = "Malaria presumed and confirmed case data as at 23 October 2023",
       y = "Cases per 1000",
       caption = str_wrap("We see that the incidence rate for malaria in Angola has generally decreased over time, but rose again after 2014. We also note wide lower and upper ranges of the data, indicating a high level of uncertainty in the exact estimate of the incidence rate. Source: World Malaria Report 2023, Annex 4-F.")) +
  theme_health_radar()
 
```

### Model Assumptions

We assume that the vector population is at equilibrium, and that ITNs are a widely-used control intervention in Angola. For more details on how to incorporate ITNs and calculating effective coverage, see the [DHS](https://jfunction.quarto.pub/healthradar/radar/datasources/malaria/dhs-program/dhs.html) page.
We also assume the human population of Angola is constant. In a more complex model you would factor in realistic projections of population growth over time, as well as malaria-induced deaths.

*Note*: The ITN data in this model is simulated. Additional interventions such as treatment or larviciding (as may be specific to Angola) have not been factored in this simple example.


```{r}

set.seed(50) # for reproducibility

# Time points for the simulation
W = 10 # model warm up
Y = 23 # years of simulation
times <- seq(0, 365*(Y+W), by = 1)

itndata <- data.frame(time = seq(0, by = 365, length.out = (Y+W)),
                      nets = rnorm((Y+W), mean = 9000000, sd = 1000000)
                    ) 

# Make a time dependent variable of ITN coverage
itn_cov <- approxfun(itndata$time, itndata$nets, n = 365*(Y), ties = "ordered", method = "constant", rule = 2)

# SEACR-SEI model
seacr <- function(times, start, parameters, itnfunc) { 
  with(as.list(c(start, parameters)), {
    P = S + E + A + C + R 
    M = Sm + Em + Im
    m = M / P
    
    #Fixed parameters
    b = 0.5 # probability of transmission from mosquito to human
    c = 0.5 # probability of transmission from human to mosquito
    r = 1/7 # rate of loss of infectiousness after treatment
    delta = 1/200 # natural recovery rate
    mu_m <- 1/10 # birth and death rate of mosquitoes
    mu_h = 1/(55*365) # birth and death rate of humans
    gamma_m = 1/10 # extrinsic incubation rate of parasite in mosquitoes
    gamma_h = 1/10 # extrinsic incubation rate of parasite in humans
    phi = 200 # phase angle; start of season
    ppn = 1.8 # persons per net
    attr = 0.7 # nets remaining after 3 years in circulation
    itn_use = 0.6 # probability of sleeping under a net
    itn_death = 1/(3*365) # median net survival is three years

    seas.t <- amp * (1 + cos(2 * pi * (times / 365 - phi)))
    
    itn_dist <- (itn_cov(times))/365*ppn/P    
    
    eta <- -log(1-(1-attr))/(3*365) #loss due to attrition over 3 years
    itn = min(ITN,1)*itn_use*itn_eff # Proportion of population covered by ITN should never be more than 1
    
    # Force of infection
    Infectious = C + zeta_a*A #infectious reservoir
    lambda = ((a^2*b*c*m*Infectious/P)/(a*c*Infectious/P+mu_m)*(gamma_m/(gamma_m+mu_m)))*seas.t*(1-itn)
    
    # Differential equations/rate of change
    dSm = 0
    dEm = 0
    dIm = 0
    
    dS = mu_h*P - lambda*S + rho*R - mu_h*S
    dE = lambda*S - (gamma_h + mu_h)*E
    dA = pa*gamma_h*E - (delta + mu_h)*A
    dC = (1-pa)*gamma_h*E - (r + mu_h)*C
    dR = delta*A + r*C - (rho + mu_h)*R
    
    dCInc = lambda*S
    dITN = itn_dist - (eta + itn_death)*ITN 
    
    # Output
    list(c(dSm, dEm, dIm, dS, dE, dA, dC, dR, dCInc, dITN))
  })
}


# Initial values for compartments
initial_state <- c(Sm = 20000000, # susceptible mosquitoes
                   Em = 20000000, # exposed and infected mosquitoes
                   Im = 20000000, # infectious mosquitoes
                   S = 16000000, # susceptible humans
                   E = 12000000, # exposed and infected humans
                   A = 6000000, # asymptomatic and infectious humans
                   C = 3000000, # clinical and symptomatic humans
                   R = 0, # recovered and semi-immune humans
                   CInc = 0, # cumulative incidence
                   ITN = 0.5 # proportion of the population with potential to be protected by nets CURRENTLY IN CIRCULATION
)

# Initial parameter estimates
initial_parameters <- c(a = 0.3, # human biting rate
                        amp = 0.6, # amplitude of seasonality
                rho = 1/200, # rate of loss of immunity after recovery
                zeta_a = 0.48, # relative infectiousness of asymptomatic infections
                pa = 0.1, # probability of asymptomatic infection
                itn_eff = 0.6 #effectiveness of nets in reducing infectious bites
                )

# Run the model

out <- ode(y = initial_state, 
           times = times, 
           func = seacr, 
           parms = initial_parameters,
           itnfunc = itnfunc)

# Post-processing model output into a dataframe

mo <- as_tibble(as.data.frame(out)) |> 
  mutate(P = S + E + A + C + R,
         M = Sm + Em + Im,
         Inc = c(0, diff(CInc))) |> 
  pivot_longer(cols = -time, names_to = "variable", values_to = "value") |> 
  filter(time > W*365) |> 
  mutate(date = ymd("1990-01-01") + time)

# Plotting incidence rate

predicted_inci_rate <- mo |> 
  filter(variable %in% c("Inc", "P")) |> 
  mutate(year = year(date)) |> 
  pivot_wider(names_from = variable, values_from = value) |>  
  group_by(year) |>
  summarize(
    annual_inc = sum(Inc, na.rm = TRUE),
    Pop = last(P)) |> # for Angola, the entire population is at risk
  mutate(pred_inci_rate = annual_inc/Pop*1000) |> 
  filter(year > 1999, year < 2022)

  ggplot() +
  geom_line(data = predicted_inci_rate, aes(x = year, y = pred_inci_rate), colour = theme_health_radar_colours[16]) +
  theme_health_radar() +
  scale_colour_manual_health_radar() +
  labs(x = "Year", 
         y = "Incidence rate per 1000", 
         title = "Angola annual country-wide malaria incidence rates",
         caption = str_wrap("This plot illustrates the country-wide incidence rate of malaria from 2000 to 2022. We see that the incidence rate decreases after 2012. Source: Model output.")) 
  
```

### Calibration

From the plot above, we see the predicted incidence rate ranges between 560 and 600 cases per 1000, whereas the incidence rate in the observed data ranged between 100 and 5000 cases per 1000. To obtain a better fit, we calibrate the model using a period of data (2013 to 2018). It is computationally intensive to calibrate all the parameters used in the model, so we name a few criteria for selecting which parameters to fix (remain the same), and which to fit (new estimates obtained through calibration). We may:
-   have less empirical support for certain values,
-   suspect that a certain parameter has a large influence on the model output (prior to doing a sensitivity analysis),
-   know a certain parameter to be driven by context-specific, unknown disease dynamics,
-   find some parameters to be "non-identifiable" (this means that it is difficult to tease out which parameter is influencing the model input. For instance, probability of transmission from mosquito to human, $b$, and the probability of transmission from human to mosquito $c$, are multiplied to calculate the force of infection. Their relative contributions will be challenging to distinguish.)

There are fitting techniques for model calibration, such as Bayesian interference and sum of least squares. Here we use maximum likelihood to assess the model's fit to the data. This is done by defining the objective function. 
```{r}

# Objective function: Negative log-likelihood
nll_seacrs <- function(initial_parameters, observed_data) {

  # Transform parameters to ensure they stay within a reasonable range, i.e. 0 to 1 for probabilities and positive for rates
  transformed_parameters <- c(a <- exp(initial_parameters['a']),
                              amp <- plogis(initial_parameters['amp']), # same as inverse logit, keeps range 0 to 1
                              rho <- exp(initial_parameters['rho']),
                              zeta_a <- plogis(initial_parameters['zeta_a']),
                              pa <- plogis(initial_parameters['pa']),
                              itn_eff <- plogis(initial_parameters['itn_eff'])
                              )
  
                
  # Solve the ODE model
  pred_out <- ode(y = initial_state, times = times, func = seacr, parms = transformed_parameters, itnfunc = itnfunc)
  model_output <- as.data.frame(pred_out)
  
  # Aggregate the daily incidence to yearly totals and calculate incidence rate
  model_output$year <- floor(model_output$time / 365)  # Group by year
  annual_incidence_rate  <- model_output |> 
    mutate(
    P = S + E + A + C + R,
    Inc = c(0, diff(CInc)),
    year = year + 1999) |> 
    group_by(year) |> 
    summarise(annual_inc = sum(Inc),
                P = last(P)) |> 
    mutate(pred_inci_rate = annual_inc/P*1000) |> 
    filter(year > 2000, year < 2020) # select years between 2000 and 2019 for fitting
    
  # Get model predictions for incidence rate
  pred_IR <- annual_incidence_rate |>
    pull(pred_inci_rate) |>
    round()

  # Incidence rate from observed data
  observed_IR <- observed_data |>
    filter(Year > 2000, Year < 2020) |>
    pull(inci_rate) |>
    round()

  # Calculate the Poisson log-likelihood for clinical cases
  log_likelihood_IR <- sum(dpois(observed_IR, lambda = pred_IR, log = TRUE))
  
  cat("Parameters: ", initial_parameters, "\n") 
  cat("Log-likelihood: ", log_likelihood_IR, "\n")

  # Return the negative log-likelihood
  return(-log_likelihood_IR)
}


initial_transformed_parameters <- c(a <- log(initial_parameters["a"]), 
                                    amp <-  qlogis(initial_parameters["amp"]), # same as logit function, exp(x)/(1+exp(x))
                                    rho <-  log(initial_parameters["rho"]), 
                                    zeta_a <-  qlogis(initial_parameters["zeta_a"]),
                                    pa <-  qlogis(initial_parameters["pa"]), 
                                    itn_eff <-  qlogis(initial_parameters["itn_eff"])
                                    )

# Minimise the negative log-likelihood
fit <- optim(par = as.list(initial_transformed_parameters), 
             fn = nll_seacrs, 
             observed_data = observed_data,
             method = "Nelder-Mead")

# New fitted parameters
fitted_params <- fit$par

# Back transform the parameters to bring them back to expected range

backtrans_params <- c(
  a <- exp(fitted_params["a"]),              # ln for exp-transformed parameters
  amp <- plogis(fitted_params["amp"]),       # qlogis for plogis-transformed parameters
  rho <- exp(fitted_params["rho"]),
  zeta_a <- plogis(fitted_params["zeta_a"]),
  pa <- plogis(fitted_params["pa"]),
  itn_eff <- plogis(fitted_params["itn_eff"])
)

# cbind(initial_parameters, backtrans_params) # compare initial parameters to newly estimated values

# Run the model with new parameters

calibrated_model <- ode(y = initial_state, 
           times = times, 
           func = seacr, 
           parms = backtrans_params,
           itnfunc = itnfunc)

# Post-processing model output into a dataframe

calibrated_mo <- as_tibble(as.data.frame(calibrated_model)) |> 
  mutate(P = S + E + A + C + R,
         M = Sm + Em + Im,
         Inc = c(0, diff(CInc))) |> 
  pivot_longer(cols = -time, names_to = "variable", values_to = "value") |> 
  filter(time > W*365) |> 
  mutate(date = ymd("1990-01-01") + time)

# Plotting incidence rate

calibrated_inci_rate <- calibrated_mo |> 
  filter(variable %in% c("Inc", "P")) |> 
  mutate(year = year(date)) |> 
  pivot_wider(names_from = variable, values_from = value) |>  # Spread Inc and P into columns
  group_by(year) |>
  summarize(
    annual_inc = sum(Inc, na.rm = TRUE),
    Pop = last(P)) |> 
  mutate(pred_inci_rate = annual_inc/Pop*1000) |> 
  filter(year > 1999, year < 2022) 


# Plot originally predicted values alongside output of newly calibrated model, and observed values
  ggplot() +
  geom_line(data = predicted_inci_rate |> mutate(label = "Preliminary model"), aes(x = year, y = pred_inci_rate, colour = label)) +
  geom_line(data = calibrated_inci_rate |> mutate(label = "Calibrated model"), aes(x = year, y = pred_inci_rate, colour = label)) +
  geom_pointrange(data = observed_data |> mutate(label = "Observed data"), aes(x = Year, y = inci_rate, ymin = inci_rate_lower, ymax = inci_rate_upper, colour = label)) +
  theme_health_radar() +
  scale_colour_manual_health_radar() +
  labs(x = "Year", 
         y = "Incidence rate per 1000", 
       colour = "Source",
         title = "Modelled malaria incidence rates for Angola",
         caption = str_wrap("The plot above indicates the improved model projection of incidence rate as an output of the model. The calibrated model provides a better fit for the data. Source: Model output.")) 

```

After calibration, the next step is to validate the model, ensuring that it continues to replicate data outside of the calibration period. In our case, we would use data from 2019 to 2022 to assess the model performance. A sensitivity analysis would help identify which parameters have the most influence on model outputs, and quantify the level of uncertainty in the parameters, further strengthening the reliability of the model.


:::