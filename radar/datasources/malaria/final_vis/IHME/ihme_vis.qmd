---
execute:
  warning: false
  error: false
---

```{r, output = FALSE}
source("../theme_health_radar.R")
library(readxl)
library(tidyverse)
```

To access the data used in the next two plots:

1.  Navigate to the ['Sub-Saharan Africa Insecticide-Treated Bed Nets 1999-2008' page](https://ghdx.healthdata.org/record/ihme-data/sub-saharan-africa-insecticide-treated-bed-nets-1999-2008) on the IHME website.

2.  Select the tab labelled 'Files (1)'.

3.  Click on the link names 'Insecticide-treated bed nets (Sub-Saharan Africa) 1999-2008' to download the file.

```{r}
# Load insecticide treated nets data
ihme_nets <- read_excel(path = "IHME_INSECTICIDE_TREATED_BEDNETS_SUB_SAHARAN_AFRICA_1999_2008_0.xls")

# Pull the names of countries
ihme_nets |> 
  pull(Country) |> 
  unique()
```

```{r}
library(gt)

# define the E8 countries
e8_countries <- c("Angola", "Botswana","Eswatini", "Mozambique", "Namibia", "South Africa", "Zambia",  "Zimbabwe")

ihme_nets |> 
  mutate(Country = ifelse(Country == "Swaziland", "Eswatini", Country)) |> 
  filter(Country %in% e8_countries) |> 
  head() |> 
  gt()
```

As these data are estimated and lower and upper bounds are provided, a line plot is used to show the change in estimated ITN ownership over time, with ribbons representing the confidence intervals.

```{r}
# Modify the Country names to replace "Swaziland" with "Eswatini"
ihme_nets |> 
  mutate(Country = ifelse(Country == "Swaziland", "Eswatini", Country)) |> 
  # Filter the data for Frontline 4 countries
  filter(Country %in% c("Namibia", "South Africa", "Eswatini", "Botswana")) |> 
  # Create a ggplot object with the filtered data
  ggplot(aes(x = Year, y = `% ITN Ownership`, color = Country)) +
  # Add lines to the plot, coloured by Country
  geom_line(linewidth = 1) +
  # Add ribbons to the plot to represent the confidence intervals, filled by country
  geom_ribbon(aes(ymin = `% ITN Ownership Lower Bound`, ymax = `% ITN Ownership Upper Bound`, fill = Country), alpha = 0.2) +
  # Apply custom colour scale for lines
  scale_colour_manual_health_radar() +  
  # Apply custom fill scale for ribbons
  scale_fill_manual_health_radar() +   
  # Apply custom theme
  theme_health_radar() +
  # Add labels and title to the plot
  labs(
    title = "Estimated ITN ownership in Frontline 4 countries (1999-2008)",
    x = "Year",
    y = "ITN Ownership (%)",
    color = "Country",
    fill = "Country",  
    caption = str_wrap(
      "The estimated ITN ownership in the Frontline 4 countries from 1999 to 2008. Lines indicate the ownership estimates, while shaded areas represent the confidence bands. The uncertainty in ITN ownership increases over time for all countries. South Africa and Eswatini had the lowest levels of ITN ownership, but after 2004, there is a significant rise in ownership in Botswana and Namibia. Source: Institute for Health Metrics and Evaluation (IHME). Available from: https://doi.org/10.6069/DEE3-E887", 
      width = 100))
```

No bounds are provided for estimated ITN ownership in at-risk populations, so a simple line graph is used to represent these data.

```{r}
# Modify the Country names to replace "Swaziland" with "Eswatini"
ihme_nets |> 
  mutate(Country = ifelse(Country == "Swaziland", "Eswatini", Country)) |> 
  # Filter the data for E8 countries
  filter(Country %in% e8_countries) |> 
  # Create a ggplot object with the filtered data
  ggplot(aes(x = Year, y = `% ITN Ownership Pop. At Risk`, color = Country)) +
  # Add lines to the plot, coloured by Country
  geom_line(linewidth = 1) +
  # Apply custom colour scale
  scale_colour_manual_health_radar() + 
  # Apply custom theme
  theme_health_radar() +
  # Add labels and title to the plot
  labs(
    title = "Estimated ITN ownership in at-risk populations (1998-2008)",
    x = "Year",
    y = "ITN Ownership (%)",
    colour = "E8 Country",
    caption = str_wrap(
      "The estimated ITN ownership among populations at-risk for malaria in Elimination 8 (E8) countries, from 1998 to 2008. The rise in ITN ownership is estimated in all countries, with Zambia, Botswana and Zimbabwe showing the highest percent ownership in 2008, followed by Namibia, Mozambique and Angola. South Africa and Eswatini maintain less than 20% ownership in at-risk populations. Source: Institute for Health Metrics and Evaluation (IHME). Available from: https://doi.org/10.6069/DEE3-E887", 
      width = 90))
```

The 'observed_cases' data can be accessed as follows:

1.  Navigate to the [IHME data portal](https://vizhub.healthdata.org/gbd-results/).

2.  In the search panel on the left-hand side, make the following selections:

    -   Set GBD Estimate to 'Cause of death or injury'.

    -   Select the measures 'Prevalence' , 'Incidence' and 'Deaths'.

    -   Select the metrics 'Number', 'Percent' and 'Rate'.

    -   Set Cause to 'Malaria'.

    -   For Location, select the E8 Countries.

    -   Set Age to 'All Ages'.

    -   Set Sex to 'Both'.

    -   Select the years from 2000 to 2021.

3.  Press the download button and follow the prompts to download your file.

```{r}
observed_cases <- read_csv("IHME-GBD_2021_DATA-05f6b66f-1.csv", show_col_types = FALSE) |>
  mutate(location_name = ifelse(location_name == "Swaziland", "Eswatini", location_name))

observed_cases |> 
  pull(location_name) |> 
  unique()
```

```{r}
library(gt)

observed_cases |> 
  filter(location_name == "South Africa") |>
  head() |> 
  gt()

```

A stacked bar plot has been used to show the estimated number of malaria deaths in the E8 countries from 2000 to 2021.

```{r}
# Convert the observed_cases data to a data frame
observed_cases |> 
  as.data.frame() |> 
  # Filter the data for deaths and rate metrics
  filter(measure_name == "Deaths", metric_name == "Rate") |> 
  # Group the data by location
  group_by(location_name) |> 
  # Create a ggplot object with the filtered and grouped data
  ggplot() +
  # Add stacked bar plots to the chart, filled based on location
  geom_bar(aes(x = year, y = val, fill = location_name), stat = "identity", position = "stack") +
  # Apply custom fill colour scale
  scale_fill_manual_health_radar() +   
  # Apply custom theme
  theme_health_radar() +
  # Add labels and title to the plot
  labs(
    title = "Estimated malaria death rate (2000-2021)",
    x = "Year",
    y = "Deaths (rate per 100 000)",
    fill = "E8 Country",
    caption = str_wrap(
      "The Institute of Health Metrics and Evaluation's (IHME) estimates of the malaria death rate in Elimination 8 (E8) countries for the 2000 to 2021 period. The highest death rate is estimated for Mozambique, followed by Angola. Substantially fewer deaths are estimated for Namibia, Botswana, South Africa, and Eswatini during this period, but it should be noted that the populations at risk of malaria in countries such as South Africa, are much lower than those in countries such as Angola and Mozambique. Source: Institute for Health Metrics and Evaluation (IHME). Global Burden of Disease Study 2021 (GBD 2021) Results. Seattle, WA: IHME, University of Washington, 2024. Available from: https://vizhub.healthdata.org/gbd-results/", 
      width = 100))
```

Upper and lower bounds were again available for the estimated malaria incidence rate, so a line plot with ribbons was chosen to visualise these data.

```{r}
# Convert the observed_cases data to a data frame
observed_cases |> 
  as.data.frame() |> 
  # Filter the data for incidence and rate metrics
  filter(measure_name == "Incidence", metric_name == "Rate") |> 
  # Create a ggplot object with the filtered data
  ggplot(aes(x = year, y = val, color = location_name)) +
  # Add lines to the plot, coloured by location name
  geom_line(linewidth = 1) +
  # Add ribbons to the plot to represent the confidence intervals, filled based on location
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = location_name), alpha = 0.2) +
  # Apply custom colour scale for lines
  scale_colour_manual_health_radar() +  
  # Apply custom fill scale for ribbons
  scale_fill_manual_health_radar() +
  # Apply custom theme
  theme_health_radar() +
  # Add labels and title to the plot
  labs(
    title = "Estimated malaria incidence rate (2000-2021)",
    x = "Year",
    y = "Incidence (rate per 100 000)",
    colour = "E8 Country",
    fill = "E8 Country",  
    caption = str_wrap(
      "The estimated malaria incidence rate per 100 000 people from 2000 to 2021 in Elimination 8 (E8) countries. The lines show estimated incidence rate and the shaded areas show the uncertainty intervals. Mozambique is estimated to have experienced malaria incidence of 47 452.43 cases per 100 000 people in 2000, which decreased to 32 050.40 cases per 100 000 by 2021. Zimbabwe is estimated to have experienced erratic malaria incidence, with cases fluctuating over the 21 year period depicted. Note that the low incidence rates estimated in countries such as South Africa and Botswana may be related to the low proportion of their total populations living in regions in which malaria is common. Source: Institute for Health Metrics and Evaluation (IHME). Global Burden of Disease Study 2021 (GBD 2021) Results. Seattle, WA: IHME, University of Washington, 2024. Available from: https://vizhub.healthdata.org/gbd-results/", 
      width = 85))
```
