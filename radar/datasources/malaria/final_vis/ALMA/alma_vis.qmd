---
execute:
  warning: false
  error: false
---

```{r, output = FALSE}
# load the libraries
source("../theme_health_radar.R")
library(ggrepel)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(readxl)
library(stringr)
library(dplyr)
```


A map is a useful way of visualising the number of reported cases of malaria in the provinces of Rwanda in 2022. 
 
```{r}
# Define the Rwanda provinces
rwanda_provinces <- c("East", "South", "West", "North", "Kigali city")

# Load the map data for Rwanda
rwanda_map <- ne_states(country = "Rwanda", returnclass = "sf") %>%
  mutate(name = rwanda_provinces)

# Read in data
rwandap_data <- read_excel("rwanda_q1_provinces2022.xlsx")

cases <- rwandap_data$MalariaTotalCases 

# Merge the map data with your data
rwanda_data <- rwanda_map %>%
  left_join(rwandap_data, by = c("name" = "province"))

# Create a ggplot object with the Rwanda data
ggplot(data = rwanda_data) +
  # Add a spatial plot with fill based on the number of cases
  geom_sf(aes(fill = cases), color = "lightgrey", size = 0.3) +  
  # Apply custom theme
  theme_health_radar() +
  # Apply custom fill scale for continuous data
  scale_fill_continuous_health_radar(name = "Total Cases") +  
  # Add text labels for the names, with color based on the number of cases
  geom_sf_text(
    aes(label = name, color = ifelse(cases > quantile(cases, 0.9), "black", "white")), size = 3) +  
  # Use identity scale for color
  scale_color_identity() +  
  # Customize the theme to remove axis titles and ticks
  theme(
    plot.caption.position = "plot",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()) +
  # Add caption and title to the plot
  labs(
    title = "Reported malaria cases in Rwanda (2022)",
    caption = str_wrap(
      "The total number of new outpatient department (OPD) cases of malaria recorded at healthcare facilities in the five provinces of Rwanda during the first quarter of 2022. The East and South provinces show the lowest and highest number of reported cases respectively. Source: ALMA Scorecard Hub, Scorecard management tool.", 
      width = 85))
```
 
```{r}
# PDF containing data available at: https://alma2030.org/our-work/scorecard-tools/alma-scorecard-for-accountability-and-action/list-of-alma-scorecards/

# Creating the data frame
Country <- c("Angola", "Angola", "Angola",
             "Botswana", "Botswana", "Botswana",
             "Eswatini", "Eswatini", "Eswatini",
             "Mozambique", "Mozambique", "Mozambique",
             "Namibia", "Namibia", "Namibia",
             "South Africa", "South Africa", "South Africa",
             "Zambia", "Zambia", "Zambia",
             "Zimbabwe", "Zimbabwe", "Zimbabwe")

Year <- rep(2023, 24)  # Same year for all entries
Quarter <- rep(1:3, times = 8)  # Three quarters for each country
Operational_LLINS_IRS <- c(58, 62, 56,  # Angola
                           0, 66, 66,   # Botswana
                           90, 91, 91,  # Eswatini
                           100, 100, 100, # Mozambique
                           64, 64, 64,   # Namibia
                           70, 86, 86,   # South Africa
                           88, 100, 100, # Zambia
                           94, 94, 94)   # Zimbabwe

# Create the data frame
dataframe <- data.frame(Country, Year, Quarter, Operational_LLINS_IRS)

# Display the dataframe
knitr::kable(head(dataframe))
```

Grouped bar plots can be used to represent data recorded in different locations at a few distinct points in time. Here, coverage by an LLIN and/or IRS in each of the E8 countries in the first three quarters of 2023 is visualised in this way. 

```{r}
# Create a ggplot object with the dataframe
ggplot(dataframe, aes(fill = as.factor(Quarter), y = Operational_LLINS_IRS, x = Country)) +
  # Add bar plots to the chart, with bars dodged side-by-side and filled by Quarter
  geom_bar(position = "dodge", stat = "identity") +  
  # Apply custom fill color scale
  scale_fill_manual_health_radar() +  
  # Apply custom theme
  theme_health_radar() +  
  # Customize the x-axis text to be angled and adjusted
  theme(axis.text.x = element_text(angle = 45, hjust = 0.4)) +
  # Add labels and title to the plot
  labs(
    title = "Operational coverage by LLINs or IRS (2023)",
    x = "E8 Country",
    y = "LLIN or IRS Coverage (%)",
    fill = "Quarter",
    caption = str_wrap(
      "The operational coverage by long-lasting insecticidal nets (LLINs) or indoor residual spraying (IRS) for the Elimination 8 (E8) countries in the first three quarters of 2023. Each bar represents the percentage of the at-risk population covered by operational LLINs or IRS, aiding in understanding of coverage disparities between countries. Mozambique achieved 100% operational coverage throughout 2023, while Angola and Namibia did not exceed 64% operational coverage. No data was available regarding the operational coverage of LLINs or IRS in Botswana in the first quarter of 2023. Source: ALMA Scorecard Hub, ALMA Scorecard for Accountability on Action.", 
      width = 85))
```

When visualising similar data over a much longer period of time, a line plot is useful. Here, the coverage by an LLIN and/or IRS in each of the Frontline 4 countries from 2015 to 2024 is visualised.

```{r}
# Read in data
E8_data <- read_excel("E8_implementation.xlsx")
E8_data$LLINs <- as.numeric(E8_data$LLINs)  

# Filter the data for specific countries
E8_data |> 
   # Keep rows where Country is one of the Frontline 4
  filter(Country %in% c("Botswana", "Namibia", "South Africa", "Eswatini")) |> 
  # Create a ggplot object with the filtered data
  ggplot(aes(x = Year, y = as.numeric(LLINs), group = Country)) +
  # Customize the x-axis to show yearly breaks
  scale_x_continuous(breaks = seq(floor(min(E8_data$Year)), ceiling(max(E8_data$Year)), by = 1)) +  
  # Customize the y-axis to show breaks from 0 to 100 in increments of 10
  scale_y_continuous(breaks = seq(0, 100, by = 10)) +  
  # Add lines to the plot, coloured by Country
  geom_line(aes(color = Country), lwd = 1) +  
  # Add points to the plot, coloured by Country
  geom_point(aes(color = Country), size = 2) +
  # Apply custom colour scale
  scale_colour_manual_health_radar() +  
  # Apply custom theme
  theme_health_radar() +
  # Add labels and title to the plot
  labs(
    title = "Operational LLIN or IRS coverage for the Frontline 4 (2015-2024)",
    x = "Year",
    y = "Coverage (%)",
    color = "Country",
    caption = str_wrap(
      "Operational long-lasting insecticidal nets (LLINs) or indoor residual spraying (IRS) coverage as a percentage of the at-risk population in the Frontline 4 countries. Solid lines represent the coverage trends taken during each quarter from 2015 to the end of 2023. Namibia experienced a large drop in coverage at the start of 2020, and only began to recover in 2023. South Africa and Eswatini appear to have consistently achieved above 70% coverage. Source: ALMA Scorecard Hub, ALMA Scorecard for Accountability on Action.", 
      width = 85
    )
  )
```

 
 