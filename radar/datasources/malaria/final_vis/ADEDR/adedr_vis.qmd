---
execute:
  warning: false
  error: false
---

```{r, output = FALSE}
source("../theme_health_radar.R")   # source in the theme functions
library(rdhs)
library(ggrepel)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(whowmr)
library(dplyr)
library(stringr)
library(tidyr)
library(forcats)
```

To access the specific data used in the visualisations:

1.  Navigate to the [Malaria Threats Map page](https://apps.who.int/malaria/maps/threats/)

2.  Below the right-most window labelled 'Data Download', click on the 'DOWNLOAD DATA' button.

3.  Select the 'Antimalarial drug efficacy and resistance' tile.

4.  Select 'Therapeutic efficacy studies' from the dropdown menu.

5.  Select 'ADD TO DOWNLOAD', and then select 'NEXT STEP'. Follow the prompts to download your file.

```{r}
# Define the elimination 8 countries
e8_countries <- c("Botswana", "Eswatini", "Namibia", "South Africa", "Angola", "Mozambique", "Zambia", "Zimbabwe")

# Read data from an Excel file, specifically from the "Data" sheet
data <- readxl::read_xlsx("MTM_THERAPEUTIC_EFFICACY_STUDY_20241216.xlsx",
                          sheet = "Data")

# Convert specific columns to numeric type
data$`POSITIVE_DAY_3 (days)` <- as.numeric(data$`POSITIVE_DAY_3 (days)`)
data$TREATMENT_FAILURE_PP    <- as.numeric(data$TREATMENT_FAILURE_PP)
data$TREATMENT_FAILURE_KM    <- as.numeric(data$TREATMENT_FAILURE_KM)

# Reshape the data from wide to long format, selecting columns 12 to 16
dat_long <- data |> 
  pivot_longer(12:16, names_to = "Indicator", values_to = "Value") |> 
  filter(COUNTRY_NAME %in% e8_countries)  # Filter rows to include only E8 countries

# Filter the long data for treatment failure per protocol (PP)
dat_trt_pp <- dat_long |> filter(Indicator == "TREATMENT_FAILURE_PP")

# Filter the long data for sample size
dat_sample <- dat_long |> filter(Indicator == "SAMPLE_SIZE")

```

A stacked bar plot is a useful way of visualising a total value that is made up of a number of contributions. Here, the total number of patients that completed a MTM therapeutic efficacy study per year between 2010 and 2021 are visualised, with the contributions from each of four of the E8 countries highlighted.

```{r}
# Number of individuals that completed a study in the e8 countries in a given year
ggplot(dat_sample, aes(x = YEAR_END, y = Value, fill = COUNTRY_NAME)) +
  geom_bar(stat = "identity", position = "stack") +
  # Apply the custom fill scale for Country
  scale_fill_manual_health_radar() +  
  # Apply the custom radar theme
  theme_health_radar() + 
  # Center title
  theme(plot.title.position = "plot") +
  # Add labels and title to the plot
  labs(
    title = "Number of patients that completed a MTM therapeutic efficacy study \n (2010-2021)",
    y = "Number of Patients",
    x = "Year",
    fill = "Country",
    caption = str_wrap("The number of patients that completed a Malaria Threats Map Therapeutic Efficacy Study between 2010 and 2021, for any drug. This excludes all patients that withdrew or were lost to follow-up. Contributions vary by country and year, with Zimbabwe having the highest number of patients complete the study for any year in 2010 (768 patients), and the most patients completing the study across E8 countries in 2015 (1039 patients). Source: Malaria Threats Map Therapeutic Efficacy Study.", width = 85)
  ) 
```

The percentage of patients who experienced treatment failure at different Zimbabwean sites can be visualised using a faceted bar plot.

```{r}
# Filter the data for Zimbabwe only, and remove sites Gokwe and Chiredzi - missing data
filt_data = dat_trt_pp |> filter(COUNTRY_NAME == "Zimbabwe" & !(SITE_NAME %in% c("Gokwe", "Chiredzi")), DRUG_NAME == "Artemether-lumefantrine")
# Define a single color for the bars
single_color <- "#1b9e77"

# Plot the data as a bar plot
ggplot(filt_data, aes(x = as.factor(YEAR_END), y = Value, fill = single_color)) +
  # Create bar plot with no legend
  geom_bar(stat = "identity", position = "dodge", show.legend = FALSE) + 
  # Use the health radar color scheme
  scale_fill_manual_health_radar() +
  # Set y-axis ticks to increment by 2
  scale_y_continuous(breaks = seq(0, max(filt_data$Value, na.rm = TRUE), by = 2)) +  
  # Facet the plot by SITE_NAME, creating 6 subplots
  facet_wrap(~ SITE_NAME) +
  # Apply the health radar theme
  theme_health_radar() +
  # increase separation between panels
  theme(panel.spacing = unit(1, "lines")) +
  # Add titles and labels
  labs(
    title = "Percentage of patients with treatment failure (2010, 2014 and 2017)",
    x = "Year",
    y = "Percentage of Patients",
    caption = str_wrap("The percentage of patients with treatment failure in Artemether-lumefantrine drug trials ending in the years 2010, 2014 and 2017, for trials run at selected sites in Zimbabwe. Note that the y-axis ranges from 0% to 9.1%. This maximum percentage of patients with treatment failure (9.1%) occurs at the Beitbridge site in 2010. At least one trial is completed at each site with an observed treatment failure of 0%. It should be noted that the number of patients who completed each trial differs drastically between trials, with the minimum being 13 at the Uzumba-Maramba-Pfungwe site in 2017, and the maximum being 109 participants at the Mutasa site in 2010. This impacts the probability of observing a patient with treatment failure. Source: Malaria Threats Map Therapeutic Efficacy Study.", width = 100))

# Is the treatment working nearly perfectly, or is there some other factor potentially at play with a number of sites having treatment failure of 0% in 2017? There is no missing data (i.e. these aren't NaNs), and the sample sizes range between 13 and 103, so they are mostly respectable. I feel like I may have missed a mitigating factor which should be mentioned in the caption
```

A lollipop plot can be used to visualise the percentage of patients who experienced treatment failure on different drugs, in different countries. A problem is encountered, however, if multiple trials in the same country had the same percentage of patients with treatment failure. Jittering is used to solve this problem, which decreases the visual appeal but ensures that important information is not obscured.

```{r}
library(stringr)

# Set seed to ensure identical jittering every time the plot is built
set.seed(18)

dat_trt_pp |> 
  # Filter the data to include only rows where Value is not NA and YEAR_END is 2015
  filter(is.na(dat_trt_pp$Value) == FALSE, YEAR_END == 2015) |>
  # Create ggplot object with the filtered data
  ggplot(aes(x = fct_reorder(COUNTRY_NAME, Value, .na_rm = FALSE),  # Reorder COUNTRY_NAME based on Value
                          y = Value,             # Set y-axis to Value
                          color = DRUG_NAME)) +  # Color points by DRUG_NAME
  # Add grey segments from y=0 to the value for each country
  geom_segment(aes(x = COUNTRY_NAME, xend = COUNTRY_NAME, y = 0, yend = Value), color = "grey") +  
  # Add jittered points to the plot, sized at 4
  geom_jitter(size = 4, height = 0, width = 0.2) +
  # Flip the coordinates for a horizontal bar plot
  coord_flip() +  
  # Apply custom color scale
  scale_colour_manual_health_radar() +
  # Apply custom theme
  theme_health_radar() +
  # Shift the title position
  theme(plot.title.position = "plot") +
  # Add labels and title to the plot
  labs(
    title = "Percentage of patients with treatment failure (2015)",
    caption = str_wrap(
      "The percentage of patients with treatment failure in trials ending in the year 2015, in selected E8 countries, highlighting the drug which was being tested. Note that the x-axis ranges from 0% to 13.6%. Each country has at least two trials which showed no evidence of treatment failure. The highest percentage of patients who experienced treatment failure (13.6%) was observed in an Angolan trial for the drug Artemether-lumefantrine. It should be noted that the number of patients who completed each trial differs drastically between trials, with the minimum being 56 at an Angolan site trialing the drug Artesunate-amodiaquine, and the maximum being 145 participants at a Zambian site trialing the drug Artemether-lumefantrine. This impacts the probability of observing a patient with treatment failure. Source: Malaria Threats Map Therapeutic Efficacy Study.", 
      width = 65),
    x = "",
    y = "Percentage", 
    colour = "Drug")
```
