---
execute:
  warning: false
  error: false
---

The data used in the creation of this first plot can be accessed as follows:

1.  Navigate to the [MAP Data page](https://data.malariaatlas.org/trends?year=2022&metricGroup=Malaria&geographicLevel=admin0&metricSubcategory=Pf&metricType=rate&metricName=incidence)

2.  Select the dropdown menu labelled 'Trends' visible on the top left-hand side of the page. From this dropdown menu, select the 'Interventions' option.

3.  A world map should be visible at the bottom of your screen. Just above this map are the options 'National', 'Subnational' and 'Pixel'. Select 'Subnational'.

4.  To the far right of the 'Subnational' button, click on the button labelled 'Download ITN Rate Data'.

5.  A popup should appear on your screen. Leave all metrics selected, but select just the year 2022 and the regions of Malawi. 6. Click 'Download selected'.

```{r, output = FALSE}
# Load packages
source("../theme_health_radar.R")
library(tidyverse)
```

```{r}
# Load the selected data
data <- read.csv("Subnational Unit-data.csv")

# Plot ITN metrics at a subnational level in Malawi
ggplot(data, aes(x = as.factor(Name), y = Value, fill = Metric)) +
  # Create bar plot with identity statistic and no legend
  geom_col(position = "dodge") + 
  # Use the health radar color scheme
  scale_fill_manual_health_radar() +
  # Set y-axis ticks increment to 10
  scale_y_continuous(breaks = seq(0, max(data$Value, na.rm = TRUE), by = 10)) +  
  # Add titles and labels
  labs(
    title = "Estimated subnational ITN use, access, and use rate in Malawi (2022)",
    x = "Region",
    y = "ITN Use* (per 100 people)",
    caption = str_wrap("Estimated subnational ITN use, access, and use rate (ITN use given access) per 100 people in Malawi in the year 2022. We can see that only a slightly higher proportion of the population has access to ITNs than uses them in every region of Malawi, which is reflected in the relatively high use rates, all of which are above 80%. Source: MAP 2024. *Or access or use rate", width = 100)) + 
  # Apply the health radar theme
  theme_health_radar() 
```

To download raster files from the MAP website,

1.  Click on “Maps”

2.  Select the drop down arrow titled “Layer Catalogue”

3.  Select the data theme of interest, such as “Accessibility”

4.  Click the “Download” symbol beside the description of the dataset in which you are interested.

As the resulting dataset for global walking only travel time to healthcare is very large, the code which follows uses a version of this data which has been filtered to include data for Zambia only.

```{r}
library(tidyverse)
library(sf)
library(terra)
library(patchwork)

# Specific link used to access Shapefile: (https://data.grid3.org/datasets/d27357c640394f11943316e36cebaba3_0/about)

# Load the data and filter by provinces of interest
shp_zambia <- sf::st_read(
            "Zambia_-_Administrative_District_Boundaries_2022.shp", 
  quiet = TRUE) |>  
  filter(PROVINCE %in% c("Eastern", "Northern", "Southern", "Western")) 


# Load raster file containing walking only travel time to healthcare
raster_walk <- rast("202001_Global_Walking_Only_Travel_Time_To_Healthcare_ZMB.tiff")

# Extract mean walking time to health facility in each district 
df_walk <- terra::extract(raster_walk, shp_zambia, mean, na.rm = T, ID = T) |>  
  as.data.frame() |>  
  tibble::rownames_to_column() |> 
  mutate(OBJECTID = as.numeric(rowname)) |>  #OBJECTID is the unique ID in the shapefile
  left_join(shp_zambia, by = c("OBJECTID"))

```

The mean walking time to access healthcare by Zambian district can be visualised using a bar plot. The province in which each district is located can be distinguished by colour.

```{r}
# Filter the data to include only rows where PROVINCE is not NA
df_walk <- df_walk |>
  filter(is.na(PROVINCE) == FALSE) |>  # Remove rows with missing PROVINCE values
  arrange(PROVINCE, DISTRICT)  # Arrange the data by PROVINCE first, and then DISTRICT in ascending order

  # Create a ggplot object with the filtered and sorted data
  # Adjust the order of the factor variable DISTRICT's levels so that districts in the same province appear together
  df_walk |> ggplot(aes(x = factor(DISTRICT, levels = df_walk$DISTRICT), 
                        y = `202001_Global_Walking_Only_Travel_Time_To_Healthcare_ZMB`, 
                        fill = PROVINCE)) +
  # Add bar plots to the chart, with bars filled by PROVINCE
  geom_bar(stat='identity') +
  # Apply custom theme
  theme_health_radar() +
  # Customize the x-axis text to be angled and adjusted
  theme(axis.text.x = element_text(angle = 70, hjust = 0.6)) +
  # Apply custom fill color scale
  scale_fill_manual_health_radar() + 
  # Add labels and title to the plot
  labs(
    title = "Mean walking time to access healthcare in Zambia, by district",
    x = "District",
    y = "Mean Walking Time (min)",
    fill = "Province",
    caption = str_wrap(
      "The average walking time in minutes of various districts in selected provinces from their closest healthcare provider. The Northern province has districts with some of the highest walking times to access healthcare, while the Eastern Province district of Chadiza has the lowest. This lowest average walking time to a healthcare facility is still over an hour. Source: MAP", 
      width = 100))
```
