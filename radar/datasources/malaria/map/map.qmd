---
title: "Malaria Atlas Project (MAP)"
description: "The Malaria Atlas Project (MAP) is a leading global resource that compiles and analyses spatial data on malaria transmission and prevalence."
date: 09/23/2024 # mm-dd-yyyy
image: "images/map.png"
lightbox: true
execute:
  message: false
  warning: false

language: 
  title-block-published: "Last updated"
  
page-layout: full
title-block-banner: "#EDF3F9"
title-block-banner-color: "#212529"
categories:
  - malaria
  - epidemiology
  - spatiotemporal
  - raster
---

::: {.page-tabs .panel-tabset}

## Overview

<h2>About the data</h2>

The Malaria Atlas Project (MAP) is a leading global resource that compiles and analyses spatial data on malaria transmission and prevalence. The MAP site houses millions of data elements and provides innovative analytical approaches to making sense of complex malaria data. 

The analytical approaches available on the site use geospatial analysis, spatiotemporal statistical methods, machine learning, and computational disease models. 

Collaboratively, MAP produces these outputs with a core team based at the Telethon Kids Institute and Curtin University in Perth, Western Australia, and Ifakara Health Institute in Dar es Salaam in Tanzania, and has members in Europe, the United States, Africa and Asia.

<h2>Accessing the data</h2>

MAP data can be accessed directly from [https://data.malariaatlas.org/](https://data.malariaatlas.org/) in various formats, including:  

1. By generating maps and charts on the site by selecting parameters of interest. The site also allows overlying various variables spatially. 

2. By downloading CSV and Raster file formats for analysis using other software outside the site. The Downloading process allows filtering counties of interest and subnational categories. 

<h2>What does the data look like?</h2>

**Description**

MAP estimated data on malaria covers morbidity, mortality, interventions, and contributing factors, primarily covering the years from 2000 to 2022 (as of 2024). Specifically; 

- Incidence and prevalence 
- Mortality 
- Treatment 
- Accessibility factors
- Insecticide-treated nets (ITNs)
- Indoor residual spraying
- Vector occurrence 
- Human population
- Housing quality 
- Zoonotic malaria

The data listed above can be found at [https://data.malariaatlas.org/](https://data.malariaatlas.org/)

![MAP-Data landing page](images/figure1.png){width=100% fig-align="center"}

<h2>Key points to consider</h2>

#### Estimates vs. data
Most information provided by MAP comprises modeled estimates rather than definitive data, which may be characterized with inherent uncertainties. Consequently, it is essential to acknowledge the uncertainties associated with the data when drawing conclusions. 

#### Pitfalls of annual data
MAP data are aggregated annually, which may lead to several pitfalls such as;

- Seasonal variations: Annual data may not capture the seasonal patterns of malaria transmission, which can be influenced by factors such as rainfall, temperature, and vector abundance. This can lead to an over- or underestimation of the disease burden and the impact of interventions.

- Temporal aggregation: Aggregating data annually may mask important short-term dynamics, such as outbreaks or the immediate impact of interventions.

## Working with the data

<h2>How to use this data?</h2>

Tabs below have videos that will help you navigate through the MAP data. These guids are also found on the help section of the MAP site at the site's [Help with the platform page](https://data.malariaatlas.org/help?tab=trends)


::: {.panel-tabset}

## Trends 

Trends Help Guides

{{< video https://www.youtube.com/embed/wCK6XRCG7gQ >}}

##  Maps

Map Help Guide

{{< video https://www.youtube.com/embed/qk68bNVZsXo >}}

## Commodities

Case Management Help Guide

{{< video https://www.youtube.com/embed/OCJcl1PLPH4 >}}


Insecticide Treated Nets Help Guide

{{< video https://www.youtube.com/embed/CRC8a1-M3VY >}}

:::

<h2>How to plot this data?</h2>

MAP data can be downloaded in both CSV and raster formats. We provide an example of how to extract and plot data for each format.

#### CSV format

MAP's CSV data can be downloaded to have both national and subnational level data for the metric(s) of interest. 

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "Show the code"
#| warning: false


#This code shows how to plot ITN data at a subnational level after downloading a csv format from; 
# https://data.malariaatlas.org/trends?year=2018&metricGroup=Interventions&geographicLevel=admin1&metricSubcategory=ITN&metricType=rate&metricName=use

#The data can be downloaded as explained in the Trends videos above or by clicking the following;
# "Interventions", then "Subnational", then the "Download ITN rate Data" button. 

#loading necessary libraries 

library(tidyverse)

#Load the data from the location where the downloaded csv is saved and selecting country and years.

df <- read.csv("Subnational_Unit-data.csv") %>% 
  filter(National.Unit == "Malawi", Year == 2022) 

#ploting ITN metrics at subnational level of malawi

ggplot(data = df) +
  geom_col(aes(x = Year, y = Value, fill = Metric), position = position_dodge()) +
  facet_wrap(~ Name) + 
  scale_x_continuous(breaks = seq(min(df$Year), max(df$Year), by = 2)) +  # Custom x-axis breaks
  scale_fill_manual(values = c("Access" = "#1b9e77", "Use" = "#d95f02", "Use Rate" = "#7570b3")) + # Custom colors for each Metric
  labs(y = "Per 100 people", 
       title = str_wrap("Estimated subnational ITN use, access, and use rate in Malawi in 2022", 
                        width = 45),
        caption = str_wrap("Figure shows the estimated subnational ITN use, access, and use rate (ITN use given access) in Malawi in the year 2022. Source: MAP 2024.",width = 90)) +
  theme_minimal() +
  theme(
    # Center and style the plot title and subtitle
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    # Style the axis titles and text
    axis.title = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12),
    #axis.text.x = element_text(angle = 45, hjust = 1),
    # Style the plot caption
    plot.caption = element_text(hjust = 0, size = 10, face = "italic"),
    # Adjust the plot margins
    plot.margin = margin(t = 20, r = 20, b = 40, l = 20),
    # Style the facet strip text
    strip.text = element_text(size = 12, face = "bold"),
    # Place the legend on the right
    legend.position = "right",  
    # Add light background to each facet panel
    panel.background = element_rect(fill = "#F0F0F0", color = NA),  
    # Add spacing between panels
    panel.spacing = unit(0.5, "lines"))

```


#### Raster format data extraction and plotting

Using raster data and this approach is beneficial when analyzing data at a smaller geographic scale than the subnational level, which the CSV format does not accommodate. The example outlined below demonstrates the extraction of data at the district level, but can be utilized at any level.

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "Show the code"
#| warning: false

#This code shows how to extract and plot selected access related data at a district level level after downloading a raster format from; 
# https://data.malariaatlas.org/. 

#To extract data from a raster file, you will need two types of data. 1. Raster file from MAP, and a shapefile containg  polygones you wish to extract data for. 

#MAP Raster files can be downloaded by clicking the following once at https://data.malariaatlas.org/
# "Maps", then "Layer Catalogue" drop down arrow, then you may select the data theme of interest, such as "Accessibility"
#In this example, we select "Global Walking Only Travel Time To Healthcare", then click the download symbol.

#Once we download the raster file, we proceed to download the shapefile of interest. 
#In this example we download Zambia's district level shapefille from https://data.grid3.org/
#i.e (https://data.grid3.org/datasets/d27357c640394f11943316e36cebaba3_0/about)

#loading necessary libraries 

library(tidyverse)
library(sf)
library(terra)
library(patchwork)


#Load the data from the location where the downloaded shapefile and raster files are saved.
#Here we filter by provinces of interest
shp_zambia <- sf::st_read(
  file.path("Zambia_-_Administrative_District_Boundaries_2022", 
            "Zambia_-_Administrative_District_Boundaries_2022.shp"), 
  quiet = TRUE) %>% 
  filter(PROVINCE %in% c("Eastern", "Northern", "Southern", "Western")) 


#loading raster file containing walking only travel time to healthcasre
raster_walk <- rast("Global_Walking_Only_Travel_Time_To_Healthcare_ZMB.tiff")

#extracting mean walking time to health facility in each district 
df_walk <- terra::extract(raster_walk, shp_zambia, mean, na.rm = T, ID = T) %>% 
    as.data.frame() %>% tibble::rownames_to_column() %>%
    mutate(OBJECTID = as.numeric(rowname)) %>% #OBJECTID is the unique ID in the shapefile
    left_join(shp_zambia, by = c("OBJECTID"))

#Splitting the dataframe by province to allow easy plotting.

list_district_df <- split(df_walk, df_walk$PROVINCE)

#Function below Defines a function that creates a ggplot for a given dataframe 'df'
fun_plot <- function(df){
  ggplot(data = df, aes(
    y = reorder(DISTRICT, Global_Walking_Only_Travel_Time_To_Healthcare_ZMB), 
    x = Global_Walking_Only_Travel_Time_To_Healthcare_ZMB)) +
    # Initializes ggplot with data and aesthetics; reorder districts by travel time
    geom_col(fill = "#1b9e77") +
    # Add bar columns with specified fill color
    geom_text(aes(label = round(Global_Walking_Only_Travel_Time_To_Healthcare_ZMB)), 
              hjust = -0.2, size = 2.5) +
    # Adds labels to bars showing rounded travel time
    labs(x = "", y = "", title = df$PROVINCE) +
    # Sets axis labels to blank and title to province name
    xlim(0, 450) +
    # Sets x-axis limits from 0 to 450
    theme_bw() + 
    # Customizing plot appearance: borders, text sizes, and colors
    theme(
      panel.border = element_rect(colour = "black", fill=NA, size=0.5),
      plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
      axis.text.x = element_text(size = 8, color = "black"), 
      axis.text.y = element_text(size = 8, color = "black"),
      axis.title.x = element_text(size = 8),
      axis.title.y = element_text(size = 8),
      legend.title = element_text(size = 8, colour = 'black'),
      legend.text = element_text(size = 8, colour = 'black'),
      legend.key.height = unit(1, "cm"))
}


# Applying 'fun_plot' to each dataframe in 'list_district_df' and combine plots
Reduce(`+`, lapply(list_district_df, fun_plot)) + 
  plot_annotation(
    # Adds annotations to the combined plot
    title = str_wrap("Average walking time to access healthcare in Zambia's 
                     Eastern, Northen, Southern, and Western province, by district"),
    caption = str_wrap("This illustrative plot shows the average walking time in selected provinces by 
    district. The figure indicates that Northern province has districts with the highest 
    walking time to access healthcare", width = 100),
    theme = theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      plot.caption = element_text(hjust = 0.5)))
```

<h2>How can this data be used in disease modelling?</h2>

As earlier alluded, that MAP provides modeled estimates for various interventins including IRS. Below, we show how IRS estimates from MAP can can be used for disease modeling. 

#### Preparing the data

The code below demonstrates how IRS data downloaded from MAP can be prepared for modeling, using data from Zambia as an illustrative example. In the code, we show that the coverage data are presented on a yearly basis, as depicted in the plot. However, further manipulation is required to meet most mathematical modeling requirements. Specifically, in this example, we generate the absolute number of households sprayed and, subsequently, the number of individuals protected.


```{r}
#| echo: true
#| code-fold: true
#| code-summary: "Show the code"
#| warning: false


#Installing pacman package that install and calls packages not installed
#install.packages("pacman") 

# Load packages 
library(deSolve)
library(tidyverse)
library(readxl)

#Read in IRS data.

IRSdata <- read.csv("National Unit-data.csv") %>% 
  mutate(sprayed = (Value/100)*3600000, #estimating number of households sprayed) 
         time = c(seq(0, 3285, by = 365))) #time steps for each year for 10 years
            

#Coverege plot

ggplot(data = IRSdata, aes(
    y = Value, 
    x = Year)) +
    geom_line(color = "#d95f02", linewidth = 0.8) +
    geom_text(aes(label = round(Value)), 
              hjust = -0.2, size = 2.5) +
    labs(x = "Year", y = "IRS Coverage (%)", title = "Countrywide IRS coverage for Zambia",
         caption = str_wrap("This plot illustrates yearly country-wide IRS coverage from 2013 to 2022. The graph reveals fluctuations in coverage over the years, with notable low in 2018.",width = 90)) +
    scale_x_continuous(breaks = round(seq(min(IRSdata$Year), max(IRSdata$Year), by = 1))) + # Rounding x-axis values
    theme_minimal() +
    theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 14),
        axis.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 12),
        plot.caption = element_text(hjust = 0, size = 10, face = "italic"),
        plot.margin = margin(t = 20, r = 20, b = 40, l = 20),
        strip.text = element_text(size = 12, face = "bold"),
        legend.position = "right",  
        panel.background = element_rect(fill = "#F0F0F0", color = NA),  
        panel.spacing = unit(0.5, "lines")
    )


```

#### Assumptions 

To create a robust model, it's crucial to articulate the assumptions underlying the dynamics. In our illustrative model
in the code below represented in the SEIRS (Susceptible, Exposed, Infected, Recovered) model. We assumed the following:

- Constant population of about 17,000,000, with 5 individuals per household. 
- Constant seasonality variability  - using seasonal forcing function
- All areas in the focus country are eligible for IRS
- Vector population is at equilibrium
- Transmission occurs through the contact between infected mosquitoes and susceptible humans, and vice versa.

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "Show the code"
#| warning: false


# Define basic dynamic Human-static Vector model ####
seirs <- function(t, x, parms)  {
  with(as.list(c(parms, x)), {
    M = Sm+Em+Im
    P = S+E+I+R
    m = M/P
    
    IRSc = IRSdata$sprayed*pp_h/P # proportion of the population covered by Current spraying cycle
    IRSt = IRSdata$time
    IRSe = phi*pmin(1, IRSc) # effective IRS coverage
    
    IRS <- approx(IRSt, IRSe, t, method = "constant", rule = 2)$y # annual IRS implementation
    seasn = seasn_0*(1 + amp*cospi((t - psi)/360)^2)# Seasonality
    IRSs <- IRS*seasn # Seasonal implementation
    
    lambda = ((a^2*b*c*m*I/P)/(a*c*I/P+mu_m)*(gamma_m/(gamma_m+mu_m)))*(1-IRSs)
    
    dSm=0
    dEm=0
    dIm=0
    dS= mu_h*P -lambda*S + rho*R - mu_h*S
    dE= lambda*S - (gamma_h + mu_h)*E
    dI=gamma_h*E - (r + mu_h)*I
    dR=r*I - (rho + mu_h)*R
    
    dCInc = lambda*S
    
    output <- c(dSm, dEm, dIm, dS, dE, dI, dR, dCInc)
    list(output)
  })
}
# Input definitions ####
#Initial values
start<-c(Sm = 30000000, Em=20000000, Im=800000, S=10000000, E=5000000, I=2000000,R=0, CInc = 0 )

# Parameters
parms <- c(a = 0.3, #human feeding rate per mosquito
           b = 0.5, # transmission efficiency M->H
           c=0.5, # transmission efficiency H->M
           gamma_m = 1/10, #rate of onset of infectiousness in mosquitoes
           mu_m = 1/15, #natural birth/death rate in mosquitoes
           mu_h = 1/(70*365), #natural birth/death rate in humans
           gamma_h = 1/20, #rate of onset of infectiousness in humans
           r=1/50, # recovery rate 
           rho = 1/(1*365), # 
           
           pp_h = 5, # number people per household
           no_hh = 3600000, # total number of households
           phi = 0.8, # IRS effectiveness
           seasn_0 = 0.7, #
           amp = 0.7, # Amplitude
           psi = pi # Phase
)

# Vector of timesteps
noy = 10 # number of years 
times <- seq(0, 364*noy, 1) # time in days

# Run models ####

hm<-ode(times=times, y=start, func=seirs,parms=parms)


```

#### Incidence

The code below demonstrates how to plot model outputs. In this example, we plot daily incidence from 2013 to 2022. The choice of model output to plot depends on the goals of the modeler or stakeholders. For instance, plotting incidence for this model may highlight the estimated impact of IRS on cases over time. However, it is important to note that the outputs of this model were not calibrated to real data and therefore do not reflect actual impacts or real case numbers.

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "Show the code"
#| warning: false

hmplot<-as_tibble(as.data.frame(hm)) %>% 
  mutate(P=S+E+I+R,
         Inc = c(0, diff(CInc))) %>% 
  pivot_longer(names_to = "variable", cols = !1) %>% 
  mutate(model = "human") %>% filter(variable == "Inc")


ggplot(data = hmplot, aes(
    y = value, 
    x = time / 365 + 2013)) +  # Convert time to years starting from 2013
    geom_line(color = "#7570b3", linewidth = 0.8) +
    labs(x = "Year", y = "Incidence", title = "Daily country-wide incidence",
         caption = str_wrap("This example plot illustrates the daily country-wide incidence of malaria from 2014 to 2022. The graph reveals fluctuations in incidence over the years, with notable peaks in 2018. This peak coincides with the period when IRS coverage was at its lowest, highlighting the potential impact of reduced intervention efforts on malaria transmission.",width = 90)) +
    ylim(25000, 50000) + 

    scale_x_continuous(breaks = seq(2013, 2024, by = 2)) +  # Set x-axis breaks to multiples of 2 years
    xlim(2014, 2022) + 
    theme_minimal() +
  
    theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 14),
        axis.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 12),
        plot.caption = element_text(hjust = 0, size = 10, face = "italic"),
        plot.margin = margin(t = 20, r = 20, b = 40, l = 20),
        strip.text = element_text(size = 12, face = "bold"),
        legend.position = "right",  
        panel.background = element_rect(fill = "#F0F0F0", color = NA),  
        panel.spacing = unit(0.5, "lines") )


```


:::